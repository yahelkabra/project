/* codeheart.js by Morgan McGuire from https://casual-effects.om/codeheart */
var _ch_defaultOnError=window.onerror;var _ch_isiOS=function(){var u=navigator.userAgent.toLowerCase();return u.indexOf("iphone")!==-1||u.indexOf("ipad")!==-1||u.indexOf("ipod")!==-1}();var _ch_isSafari=function(){var u=navigator.userAgent.toLowerCase();var x=(u.indexOf("iphone")!==-1||u.indexOf("ipad")!==-1||u.indexOf("ipod")!==-1||u.indexOf("safari")!==-1)&&u.indexOf("chrome")===-1;return x}();var _ch_isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")!==-1;var _ch_isLocal=window.location.toString().substr(0,7)==="file://";var _ch_isChrome=navigator.userAgent.toLowerCase().indexOf("chrome")!==-1;var _ch_isMobile=navigator.userAgent.toLowerCase().indexOf("mobi")!==-1;var _ch_isWebkit=navigator.userAgent.toLowerCase().indexOf("webkit")!==-1;if(Math.sign===undefined){Math.sign=function(x){if(x>0){return 1}else if(x<0){return-1}else{return 0}}}var _ch_audioContext;if(!(_ch_isLocal&&_ch_isChrome)){window.AudioContext=window.AudioContext||window.webkitAudioContext;if(window.AudioContext){try{_ch_audioContext=new AudioContext}catch(e){console.log(e)}}}function _ch_getInternetExplorerVersion(){var rv=-1;if(navigator.appName==="Microsoft Internet Explorer"){var ua=navigator.userAgent;var re=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");if(re.exec(ua)!=null)rv=parseFloat(RegExp.$1)}return rv}var _ch_isOldIE=_ch_getInternetExplorerVersion()>-1&&_ch_getInternetExplorerVersion()<10;var _ch_isMozilla=!_ch_isWebkit&&navigator.userAgent.toLowerCase().indexOf("mozilla")!==-1&&_ch_getInternetExplorerVersion()===-1;var _ch_hasTouchEvents="ontouchstart"in window||window.navigator.msMaxTouchPoints>0;function _ar_PAUSED_Y(){return screenHeight/8}var _ch_controlKeyMap=[];if(typeof Float32Array==="undefined")this.Float32Array=Array;if(typeof Float64Array==="undefined")this.Float64Array=Array;if(typeof Int8Array==="undefined")this.Int8Array=Array;if(typeof Uint8Array==="undefined")this.Uint8Array=Array;if(typeof Int16Array==="undefined")this.Int16Array=Array;if(typeof Uint16Array==="undefined")this.Uint16Array=Array;if(typeof Int32Array==="undefined")this.Int32Array=Array;if(typeof Uint32Array==="undefined")this.Uint32Array=Array;if(console&&!console.assert){console.assert=function(val,msg){if(!val){throw"Assertion failed: "+msg}}}navigator.getGamepads=navigator.getGamePads||navigator.getGamepads||navigator.webkitGetGamepads||function(){return[]};navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;navigator.getGamepads();if(!Math.fround){Math.fround=function(x){return x}}var _ch_gamepadState=[];function _ch_makeGamepadState(gamepad){function makeZero(n){var a=makeArray(n);for(var i=0;i<n;++i){a[i]=0}return a}var isBDAProExGamepadChromeOS=false;var isBDAProExGamepadOSX=false;var buttonRemap=undefined;var axisRemap=undefined;var NA=1e4;if(gamepad.id.toLowerCase().indexOf("bda pro ex mini")!==-1){isBDAProExGamepadChromeOS=true;buttonRemap=[0,1,2,3,4,5,NA,NA,6,7,9,10,NA,NA,NA,NA,8];axisRemap=[0,1,3,4]}else if(gamepad.id.toLowerCase().indexOf("vendor: 24c6 ")!==-1){isBDAProExGamepadOSX=true;buttonRemap=[0,1,2,3,4,5,NA,NA,9,8,6,7,11,12,13,14,10];axisRemap=[0,1,3,4]}return{isBDAProExGamepadChromeOS:isBDAProExGamepadChromeOS,isBDAProExGamepadOSX:isBDAProExGamepadOSX,buttonRemap:buttonRemap,axisRemap:axisRemap,id:gamepad.id,buttons:makeZero(25),oldButtons:makeZero(25),axes:makeZero(6),lastEventAxes:makeZero(8)}}var GAMEPAD={BUTTON:{A:0,B:1,X:2,Y:3,LEFT_SHOULDER:4,RIGHT_SHOULDER:5,LEFT_TRIGGER:6,RIGHT_TRIGGER:7,SELECT:8,START:9,LEFT_STICK:10,RIGHT_STICK:11,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15,HOME:16,LEFT_UP:17,LEFT_DOWN:18,LEFT_LEFT:19,LEFT_RIGHT:20,RIGHT_UP:21,RIGHT_DOWN:22,RIGHT_LEFT:23,RIGHT_RIGHT:24},BUTTON_NAME:[],STICK:{LEFT:0,RIGHT:1,DPAD:2,LEFT_TRIGGER:3,RIGHT_TRIGGER:4},STICK_NAME:[]};(function(){for(var k in GAMEPAD.BUTTON){GAMEPAD.BUTTON_NAME[GAMEPAD.BUTTON[k]]=k}for(var k in GAMEPAD.STICK){GAMEPAD.STICK_NAME[GAMEPAD.STICK[k]]=k}})();GAMEPAD=Object.freeze(GAMEPAD);function _ch_processGamepads(){var b,g;var gamepadArray=navigator.getGamepads();if(gamepadArray&&gamepadArray.length>0){for(g=0;g<gamepadArray.length;++g){var webGamepad=gamepadArray[g];if(webGamepad){if(_ch_gamepadState.length<g+1){gamepadArray[g]._present=true;resizeArray(_ch_gamepadState,g);_ch_gamepadState[g]=_ch_makeGamepadState(webGamepad)}var state=_ch_gamepadState[g];for(b=0;b<17;++b){state.oldButtons[b]=state.buttons[b];var r=state.buttonRemap?state.buttonRemap[b]:b;state.buttons[b]=webGamepad.buttons.length>r?webGamepad.buttons[r].value:0}if(state.isBDAProExGamepadChromeOS){state.buttons[14]=webGamepad.axes[6]<-.5?1:0;state.buttons[15]=webGamepad.axes[6]>.5?1:0;state.buttons[12]=webGamepad.axes[7]<-.5?1:0;state.buttons[13]=webGamepad.axes[7]>.5?1:0}if(state.isBDAProExGamepadChromeOS||state.isBDAProExGamepadOSX){state.buttons[6]=webGamepad.axes[2]*.5+.5;state.buttons[7]=webGamepad.axes[5]*.5+.5}for(b=17;b<25;++b){state.oldButtons[b]=state.buttons[b]}var ANALOG_DEAD_ZONE=.18;for(b=0;b<4;++b){var r=state.axisRemap?state.axisRemap[b]:b;state.axes[b]=webGamepad.axes[r];if(Math.abs(state.axes[b])<ANALOG_DEAD_ZONE){state.axes[b]=0}}state.axes[4]=state.buttons[GAMEPAD.BUTTON.DPAD_RIGHT]-state.buttons[GAMEPAD.BUTTON.DPAD_LEFT];state.axes[5]=state.buttons[GAMEPAD.BUTTON.DPAD_DOWN]-state.buttons[GAMEPAD.BUTTON.DPAD_UP]}}for(g=0;g<_ch_gamepadState.length;++g){var gamepad=_ch_gamepadState[g];var ANALOG_THRESHOLD=.05;var ANALOG_TO_BUTTON_THRESHOLD=.5;for(b=0;b<6;b+=2){if(Math.abs(gamepad.axes[b]-gamepad.lastEventAxes[b])>ANALOG_THRESHOLD||Math.abs(gamepad.axes[b+1]-gamepad.lastEventAxes[b+1])>ANALOG_THRESHOLD){gamepad.lastEventAxes[b]=gamepad.axes[b];gamepad.lastEventAxes[b+1]=gamepad.axes[b+1];_ch_onGamepadMove(gamepad.axes[b],gamepad.axes[b+1],b/2,g);if(b<4){var indexOffset=b*2;gamepad.buttons[17+indexOffset]=gamepad.axes[b+1]<-ANALOG_TO_BUTTON_THRESHOLD?1:0;gamepad.buttons[18+indexOffset]=gamepad.axes[b+1]>+ANALOG_TO_BUTTON_THRESHOLD?1:0;gamepad.buttons[19+indexOffset]=gamepad.axes[b]<-ANALOG_TO_BUTTON_THRESHOLD?1:0;gamepad.buttons[20+indexOffset]=gamepad.axes[b]>+ANALOG_TO_BUTTON_THRESHOLD?1:0}}}for(b=0;b<2;++b){if(Math.abs(gamepad.buttons[6+b]-gamepad.lastEventAxes[6+b])>ANALOG_THRESHOLD){gamepad.lastEventAxes[6+b]=gamepad.buttons[6+b];_ch_onGamepadMove(gamepad.lastEventAxes[6+b],0,3+b,g)}}for(b=0;b<gamepad.buttons.length;++b){var isDirection=b>=GAMEPAD.BUTTON.LEFT_UP&&b<=GAMEPAD.BUTTON.LEFT_RIGHT||b>=GAMEPAD.BUTTON.RIGHT_UP&&b<=GAMEPAD.BUTTON.RIGHT_RIGHT||b>=GAMEPAD.BUTTON.DPAD_UP&&b<=GAMEPAD.BUTTON.DPAD_RIGHT;if(gamepad.oldButtons[b]!==gamepad.buttons[b]){if(gamepad.buttons[b]){_ch_onGamepadStart(b,g,isDirection)}else{_ch_onGamepadEnd(b,g,isDirection)}}}}}}function _ar_onControlStart(control){if(typeof onControlStart==="function"){onControlStart(control)}control._repeatCounter=-control.delayFrames}function _ar_onControlEnd(control){if(typeof onControlEnd==="function"){onControlEnd(control)}control._repeatCounter=0}function _ar_onAnyKeyStart(control){if(currentTime()<_ar_uiReleaseTime){return false}if(uiMode()!==UIMode.PLAYING||control.classicName==="start"){switch(uiMode()){case UIMode.TITLE:setUIMode(UIMode.INSTRUCTIONS);break;case UIMode.INSTRUCTIONS:setUIMode(UIMode.PLAYING);break;case UIMode.PLAYING:setUIMode(UIMode.PAUSED);break;case UIMode.PAUSED:switch(control.classicName){case"left":_ar_uiPauseChoice=0;break;case"right":_ar_uiPauseChoice=1;break;case"A":if(_ar_uiPauseChoice===0){setUIMode(UIMode.PLAYING)}else{setUIMode(UIMode.TITLE)}break;case"start":case"select":setUIMode(UIMode.PLAYING);break}break;case UIMode.GAME_OVER:setUIMode(UIMode.TITLE);break}return false}else{return true}}function _ch_onGamepadStart(buttonId,gamepadId,isDirection){if(_ch_mode===_ch_PLAY&&typeof onGamepadStart==="function"){_ch_safeApply(onGamepadStart,buttonId,gamepadId,isDirection)}}function _ch_onGamepadEnd(buttonId,gamepadId,isDirection){if(_ch_mode===_ch_PLAY&&typeof onGamepadEnd==="function"){_ch_safeApply(onGamepadEnd,buttonId,gamepadId,isDirection)}}function _ch_onGamepadMove(x,y,stickId,gamepadId){if(_ch_mode===_ch_PLAY&&typeof onGamepadMove==="function"){_ch_safeApply(onGamepadMove,x,y,stickId,gamepadId)}}var canvas;var ui;var _ch_zoom;var _ch_ctx;var _ch_timer;var _ch_titleScreenImage;var _ch_gameName;var _ch_authorName;var _ch_orientation="H";var _ch_showTitleScreen=false;var _ch_pauseWhenUnfocused=true;var _ch_maxResolution=1280;var _ch_hasFocus=true;var _ch_INIT="INIT";var _ch_SETUP="SETUP";var _ch_TITLE="TITLE";var _ch_PLAY="PLAY";var _ch_mode=_ch_INIT;var _ch_MOUSETOUCH_IDENTIFIER=-400;var LEFT_MOUSE_BUTTON_ID=_ch_MOUSETOUCH_IDENTIFIER;var RIGHT_MOUSE_BUTTON_ID=_ch_MOUSETOUCH_IDENTIFIER+2;var screenWidth=null;var screenHeight=null;function _ch_makeCanvas(){document.write("<canvas "+'id="canvas" '+'oncontextmenu="return false" '+'width="100" '+'height="100" '+'style="'+("display: block; "+"position: fixed; "+"top: 0px; "+"left: 0px; "+"background: #000; "+"-webkit-touch-callout: none; "+"-webkit-user-select: none; "+"-khtml-user-select: none; "+"-moz-user-select: none; "+"-ms-user-select: none; "+"-webkit-tap-highlight-color: transparent; "+(navigator.userAgent.indexOf("Firefox")===-1?"user-select: none; ":"")+(!_ch_isSafari?"-webkit-transform: translateZ(0);":""))+'">'+"</canvas>");if(_ch_isMobile){document.write('<div id="_ch_eventConsumer" style="top: 0px; left: 0px; position: fixed; z-index: -1000; width: 100%; height: 100%;"></div>')}document.write("<style>html:-webkit-full-screen { width:100% !important; height:100%; background-color: black; }</style>");document.write("<style>html:-moz-full-screen { width:100% !important; height:100%; background-color: black; }</style>");document.write("<style>html:fullscreen { width:100% !important; height:100%; background-color: black; }</style>");document.write("<style>"+"div#ui { color: #FFF; font-size: 64px; }"+"div#ui input, div#ui button { font-size: 100%; }"+"</style>");document.write('<div id="ui" oncontextmenu="return false" style="position: fixed; background: rgba(0,0,0,0);'+(navigator.userAgent.indexOf("Firefox")===-1?"z-order: 10;":"")+'"></div>');ui=document.getElementById("ui");canvas=document.getElementById("canvas");screenWidth=100;screenHeight=100;codeheart.canvas=canvas;_ch_ctx=canvas.getContext("2d");_ch_setOrientation()}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(elt){var len=this.length;var from=Number(arguments[1])||0;from=from<0?Math.ceil(from):Math.floor(from);if(from<0){from+=len}while(from<len){if(from in this&&this[from]===elt){return from}++from}return-1}}var _ch_recentTouchList=new function(){this.list=[];this.add=function(touch){this.removeOld();this.list.push({x:touch.clientX,y:touch.clientY,time:currentTime()})};this.removeOld=function(){var recent=currentTime()-.5;while(this.list.length>0&&this.list[0].time<recent){this.list.pop()}};this.wasRecent=function(mouseEvent){this.removeOld();for(var i=0;i<this.list.length;++i){var t=this.list[i];if(Math.abs(t.x-mouseEvent.clientX)<=2&&Math.abs(t.y-mouseEvent.clientY)<=2){return true}}}};var _ch_touchKeysEndDrag=true;var _ch_touchKeySet=new function(){this.list=[];var activeColor=makeColor(1,1,.5,.7);var defaultColor=makeColor(1,1,1,.5);var borderColor=makeColor(0,0,0,.5);var textColor=makeColor(0,0,0,.5);this.drawAll=function(){var i,touchKey,color,scale;for(i=0;i<this.list.length;++i){touchKey=this.list[i];if(touchKey.label!==null){if(isString(touchKey.label)){color=touchKey.activeTouchIDs.length>0?activeColor:defaultColor;if(touchKey.radius>0){fillCircle(touchKey.x,touchKey.y,touchKey.radius,color);strokeCircle(touchKey.x,touchKey.y,touchKey.radius,borderColor,5);fillText(touchKey.label,touchKey.x,touchKey.y,textColor,""+touchKey.radius+"px sans-serif","center","middle")}else{fillRectangle(touchKey.x,touchKey.y,touchKey.width,touchKey.height,color,10);strokeRectangle(touchKey.x,touchKey.y,touchKey.width,touchKey.height,borderColor,5,10);fillText(touchKey.label,touchKey.x+touchKey.width/2,touchKey.y+touchKey.height/2,textColor,""+Math.min(touchKey.height,touchKey.width)+"px sans-serif","center","middle")}}else{if(touchKey.radius>0){scale=touchKey.radius/min(touchKey.label.width,touchKey.label.height);drawTransformedImage(touchKey.label,touchKey.x,touchKey.y,0,scale,scale)}else{scale=max(touchKey.width/touchKey.label.width,touchKey.height/touchKey.label.height);drawTransformedImage(touchKey.label,touchKey.x+touchKey.width/2,touchKey.y+touchKey.height/2,0,scale,scale)}}}}};this.set=function(keyCode,x,y,width,height,radius,label){if(label===undefined){label=asciiCharacter(keyCode)}var touchKey={keyCode:keyCode,x:x,y:y,width:width,height:height,radius:radius,label:label,activeTouchIDs:[]};var i=this.find(keyCode);if(i===-1){this.list.push(touchKey)}else{var old=this.list[i];if(old.x!==touchKey.x||old.y!==touchKey.y||old.width!==touchKey.width||old.height!==touchKey.height||old.radius!==touchKey.radius||old.label!==touchKey.label){if(old.activeTouchIDs.length>0){_ch_onKeyUp({keyCode:touchKey.keyCode})}this.list.splice(i,1,touchKey)}}};this.find=function(keyCode){for(var i=0;i<this.list.length;++i){if(keyCode===this.list[i].keyCode){return i}}return-1};this.remove=function(keyCode){var i=this.find(keyCode);if(i===-1){return false}else{var touchKey=this.list[i];if(touchKey.activeTouchIDs&&touchKey.activeTouchIDs.length>0){_ch_onKeyUp({keyCode:touchKey.keyCode})}this.list.splice(i,1);return true}};this.contains=function(touchKey,x,y){if(touchKey.radius>0){x-=touchKey.x;y-=touchKey.y;return x*x+y*y<touchKey.radius*touchKey.radius}else{return x>=touchKey.x&&y>=touchKey.y&&x<touchKey.x+touchKey.width&&y<touchKey.y+touchKey.height}};this.containingKeys=function(x,y){var keys=null;var touchKey;for(var i=0;i<this.list.length;++i){touchKey=this.list[i];if(this.contains(touchKey,x,y)){if(keys){keys.push(touchKey)}else{keys=[touchKey]}}}return keys};this.onTouchStart=function(x,y,id){if(_ch_isMobile&&id>=_ch_MOUSETOUCH_IDENTIFIER&&id<=RIGHT_MOUSE_BUTTON_ID){return false}var handled=false;var keys=this.containingKeys(x,y);if(keys&&keys.length>0){var touchKey;handled=true;for(var i=0;i<keys.length;++i){touchKey=keys[i];touchKey.activeTouchIDs.push(id);if(touchKey.activeTouchIDs.length===1){_ch_onKeyDown({keyCode:touchKey.keyCode})}}}return handled};this.touchKeysWithActiveId=function(id,removeID){var keys=null;var touchKey;for(var i=0;i<this.list.length;++i){touchKey=this.list[i];for(var t=0;t<touchKey.activeTouchIDs.length;++t){if(touchKey.activeTouchIDs[t]===id){if(removeID){touchKey.activeTouchIDs.splice(t,1);--t}if(keys){keys.push(touchKey)}else{keys=[touchKey]}continue}}}return keys};this.onTouchMove=function(x,y,id){if(_ch_isMobile&&id>=_ch_MOUSETOUCH_IDENTIFIER&&id<=RIGHT_MOUSE_BUTTON_ID){return{simulateTouchStart:false,simulateTouchEnd:false,consumed:false}}var keys=this.touchKeysWithActiveId(id,false);var touchKey;var i,j;var simulateTouchStart=false;var simulateTouchEnd=false;var consumed=false;if(keys){consumed=true;for(i=0;i<keys.length;++i){touchKey=keys[i];if(!this.contains(touchKey,x,y)){simulateTouchStart=true;for(j=0;j<touchKey.activeTouchIDs.length;++j){if(touchKey.activeTouchIDs[j]===id){touchKey.activeTouchIDs.splice(j,1);break}}if(touchKey.activeTouchIDs.length===0){_ch_onKeyUp({keyCode:touchKey.keyCode})}}}}keys=this.containingKeys(x,y);if(keys){consumed=true;var touchKey;for(var i=0;i<keys.length;++i){touchKey=keys[i];if(touchKey.activeTouchIDs.indexOf(id)===-1){touchKey.activeTouchIDs.push(id);_ch_onKeyDown({keyCode:touchKey.keyCode});if(!simulateTouchStart){simulateTouchEnd=true}simulateTouchStart=false}}}return{simulateTouchStart:simulateTouchStart,simulateTouchEnd:simulateTouchEnd,consumed:consumed}};this.onTouchEnd=function(x,y,id){if(_ch_isMobile&&id>=_ch_MOUSETOUCH_IDENTIFIER&&id<=RIGHT_MOUSE_BUTTON_ID){return false}var handled=false;var keys=this.touchKeysWithActiveId(id,true);if(keys&&keys.length>0){var touchKey;handled=true;for(var i=0;i<keys.length;++i){touchKey=keys[i];if(touchKey.activeTouchIDs.length===0){_ch_onKeyUp({keyCode:touchKey.keyCode})}}}return handled}};var _ch_activeTouchIDSet={};var _ch_soundLoadQueue=[];var _ch_initializedAudio=false;function _ch_processSoundLoadQueue(){if(_ch_soundLoadQueue.length===0){return}if(_ch_isiOS){if(_ch_initializedAudio){return}var buffer=_ch_audioContext.createBuffer(1,1,22050);var source=_ch_audioContext.createBufferSource();source.buffer=buffer;source.connect(_ch_audioContext.destination);if(source.start){source.start(0)}else{source.noteOn(0)}_ch_initializedAudio=true}else{for(var i=0;i<_ch_soundLoadQueue.length;++i){_ch_soundLoadQueue[i].load()}}_ch_soundLoadQueue=[]}function _ch_preventDefault(event){event.preventDefault()}function _ch_maybePreventDefault(event){if(event.target===ui||event.target===document.body){event.preventDefault()}}function _ch_removeRefreshArguments(url){var pattern="?refresh=1";var i=url.indexOf(pattern);if(i!==-1){return url.substring(0,i)+url.substring(i+pattern.length)}else{return url}}function _ch_getStackTrace(e){callstack=_ch_eriwen_getStackTrace({e:e});for(var i=0;i<callstack.length;++i){if(callstack[i]===""||callstack[i].indexOf("codeheart.js")!==-1||callstack[i]==="[native code]"){callstack.splice(i,1);--i}else{callstack[i]=_ch_removeRefreshArguments(callstack[i])}}if(_ch_isSafari){for(var i=0;i<callstack.length;++i){var c=callstack[i];var j=c.indexOf("@");if(j!==-1){callstack[i]=" at "+c.substring(0,j)+" ("+c.substring(j+1)+")"}}}return callstack}var _ch_pixelate=false;var _ch_showLoadingMessage=true;var _ch_onLoadRan=false;function _ch_onLoad(){_ch_onResize(null);if(_ch_showLoadingMessage){fillText("Loading...",screenWidth/2,screenHeight/2,makeColor(.5,.5,.5,1),"300px Arial","center","middle")}document.addEventListener("keydown",_ch_onKeyDown,false);document.addEventListener("keyup",_ch_onKeyUp,false);var target=ui;document.addEventListener("touchend",function(){},false);document.addEventListener("click",function(){},false);canvas.addEventListener("touchend",function(){},false);canvas.addEventListener("click",function(){},false);target.addEventListener("mousemove",_ch_onMouseMove,false);target.addEventListener("click",_ch_onClick,false);target.addEventListener("mousedown",_ch_onMouseDown,false);target.addEventListener("mouseup",_ch_onMouseUp,true);target.addEventListener("mousecancel",_ch_onMouseUp,true);target.addEventListener("touchstart",_ch_onTouchStart,false);target.addEventListener("touchmove",_ch_onTouchMove,false);target.addEventListener("touchcancel",_ch_onTouchEnd,true);target.addEventListener("touchend",_ch_onTouchEnd,true);target.addEventListener("wheel",_ch_onWheel,false);document.addEventListener("mouseup",_ch_onWindowMouseUp,false);document.addEventListener("mousecancel",_ch_onWindowMouseUp,false);document.addEventListener("touchend",_ch_onWindowTouchEnd,false);document.addEventListener("touchcancel",_ch_onWindowTouchEnd,false);window.addEventListener("resize",_ch_onResize,false);window.addEventListener("orientationchange",_ch_onResize,false);window.addEventListener("focus",_ch_onFocusIn,false);window.addEventListener("blur",_ch_onFocusOut,false);document.onselectstart=function(){return false};if(_ch_isMobile){var body=document.getElementsByTagName("body")[0];var consumer=document.getElementById("_ch_eventConsumer");if(consumer){consumer.addEventListener("touchmove",_ch_preventDefault,true);body.addEventListener("touchmove",_ch_maybePreventDefault,false)}else{console.warn("_ch_eventConsumer DIV is not present")}}_ch_startTimer(targetFramerate);_ch_onLoadRan=true}Object.defineProperty(window,"targetFramerate",{get:function(){return _ch_targetFramerate}});var _ch_targetFramerate=30;function _ch_startTimer(fps){_ch_timer=setInterval(_ch_mainLoop,1e3/fps-(_ch_isiOS?.75:1.8))}function _ch_stopTimer(){clearInterval(_ch_timer)}function drawCodeheartLogo(x0,y0){_ch_checkExactArgs(arguments,0,"drawCodeheartLogo(x, y)");if(x0===undefined){x0=24}if(y0===undefined){y0=screenHeight-66}var color=["rgba(0,0,0,0)","#000","#fff","#ff441f","#8c2511"];var w=17,h=10;var data=[0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,1,0,0,1,3,3,1,0,1,3,3,1,0,0,1,0,0,1,0,1,3,2,2,3,1,3,3,3,3,1,0,1,0,0,1,0,1,3,2,3,3,3,3,3,3,3,1,0,1,0,1,0,0,1,3,3,3,3,3,3,3,3,3,1,0,0,1,0,1,0,0,1,3,3,3,3,3,3,3,1,0,0,1,0,0,1,0,0,0,1,3,3,3,3,3,1,0,0,0,1,0,0,1,0,0,0,0,1,3,3,3,1,0,0,0,0,1,0,0,1,0,0,0,0,0,1,3,1,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,1,0,0,0,0,0,1,1,0];var x,y;strokeRectangle(x0-12-1,y0-12-1,300+2,66+2,makeColor(1,1,1,.3),2);fillRectangle(x0-12,y0-12,300,66,makeColor(1,1,1,.8));var s=4;var c;for(y=0;y<h;++y){for(x=0;x<w;++x){c=data[x+y*w];if(c>0){fillRectangle(x0+x*s,y0+y*s,s,s,color[c])}}}fillText("made with",x0+w*s+6,y0-8,makeColor(.4,.4,.4),"18px Helvetica, Arial","left","top");fillText("codeheart",x0+w*s+6,y0+h*s+8,makeColor(0,0,0),"38px Helvetica, Arial","left","bottom");fillText(".js",x0+w*s+174,y0+h*s+8,color[3],"38px Helvetica, Arial","left","bottom")}var _ch_drawLogo=drawCodeheartLogo;function _ch_splineTo(ctx,C,close){var x0,y0,x1,y1,x2,y2,d01,d02,a,b;var i;var B=[];var n=C.length;for(i=0;i<n;i+=2){x0=C[(i+0+n)%n];y0=C[(i+1+n)%n];x1=C[(i+2+n)%n];y1=C[(i+3+n)%n];x2=C[(i+4+n)%n];y2=C[(i+5+n)%n];d01=Math.sqrt(Math.pow(x1-x0,2)+Math.pow(y1-y0,2));d12=Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2));a=d01/(2*(d01+d12));b=.5-a;B.push(x1+a*(x0-x2),y1+a*(y0-y2),x1-b*(x0-x2),y1-b*(y0-y2))}if(close){var m=B.length;ctx.moveTo(C[2],C[3]);for(i=0;i<B.length;i+=2){ctx.bezierCurveTo(B[(2*i+2)%m],B[(2*i+3)%m],B[(2*i+4)%m],B[(2*i+5)%m],C[(i+4)%n],C[(i+5)%n])}}else{ctx.moveTo(C[0],C[1]);ctx.quadraticCurveTo(B[0],B[1],C[2],C[3]);for(i=2;i<n-5;i+=2){ctx.bezierCurveTo(B[2*i-2],B[2*i-1],B[2*i],B[2*i+1],C[i+2],C[i+3])}ctx.quadraticCurveTo(B[2*n-10],B[2*n-9],C[n-2],C[n-1])}}function _ch_safeApply(){try{var fcn=arguments[0];arguments[0]=null;Function.prototype.call.apply(fcn,arguments)}catch(e){_ch_stopTimer();var m;var st=_ch_getStackTrace(e);var i=st.indexOf("_ch_safeApply()");if(i!==-1){st.splice(i,0,fcn.name+"()")}m=String(e)+"\n\n"+_ch_callStackToString(st);console.error(m);alert(m)}}function _ch_onFocusIn(event){_ch_hasFocus=true}function _ch_onFocusOut(event){_ch_hasFocus=false}function _ch_endFullscreen(){if(document.cancelFullScreen){document.cancelFullScreen()}else if(document.cancelFullscreen){document.cancelFullscreen()}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}else if(document.msCancelFullScreen){document.msCancelFullScreen()}else if(document.oCancelFullScreen){document.oCancelFullScreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}}function _ch_startFullscreen(){var element=document.documentElement;if(element.requestFullScreen){element.requestFullScreen()}else if(element.requestFullscreen){element.requestFullScreen()}else if(element.mozRequestFullScreen){element.mozRequestFullScreen()}else if(element.oRequestFullScreen){element.oRequestFullScreen()}else if(element.msRequestFullScreen){element.msRequestFullScreen()}else if(element.webkitRequestFullScreen&&!_ch_isSafari){element.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}element.focus()}function _ch_onResize(event){var ww,wh;if(_ch_isiOS){window.scrollTo(0,0);ww=window.innerWidth;wh=window.innerHeight}else{ww=document.documentElement.clientWidth;wh=document.documentElement.clientHeight}var needTransform=_ch_maxResolution!==Math.min(screenWidth,screenHeight);if(needTransform){var old;if(_ch_maxResolution==="auto"){old=document.createElement("canvas");old.width=canvas.width;old.height=canvas.height;old.getContext("2d").drawImage(canvas,0,0)}var scale;if(_ch_maxResolution==="auto"){scale=Math.min(Math.min(screenWidth,ww)/screenWidth,Math.min(screenHeight,wh)/screenHeight)}else{if(screenWidth>screenHeight){scale=_ch_maxResolution/screenHeight}else{scale=_ch_maxResolution/screenWidth}}canvas.width=scale*screenWidth;canvas.height=scale*screenHeight;if(_ch_maxResolution==="auto"){_ch_ctx.setTransform(1,0,0,1,0,0);_ch_ctx.drawImage(old,0,0,canvas.width,canvas.height)}old=null}var cw=screenWidth;var ch=screenHeight;_ch_zoom=Math.min(ww/cw,wh/ch);if(needTransform){_ch_baseTransform=[canvas.width/screenWidth,0,0,canvas.height/screenHeight,-.5*canvas.width/screenWidth,-.5*canvas.height/screenHeight];_ch_ctx.setTransform.apply(_ch_ctx,_ch_baseTransform)}else{_ch_baseTransform=[1,0,-.5,1,0,-.5]}var z=_ch_zoom;canvas.style.width=Math.round(cw*z)+"px";canvas.style.height=Math.round(ch*z)+"px";var x=(ww-cw*z)/2;var y=(wh-ch*z)/2;canvas.style.left=Math.round(x)+"px";canvas.style.top=Math.round(y)+"px";ui.style.top=canvas.style.top;ui.style.left=canvas.style.left;ui.style.width=screenWidth+"px";ui.style.height=screenHeight+"px";var origin="top left";var xform="scale("+_ch_zoom+", "+_ch_zoom+")";ui.style["-webkit-transform-origin"]=origin;ui.style["-webkit-transform"]=xform;ui.style["-o-transform-origin"]=origin;ui.style["-o-transform"]=xform;ui.style["-ms-transform-origin"]=origin;ui.style["-ms-transform"]=xform;ui.style["transform-origin"]=origin;ui.style["transform"]=xform;ui.style.MozTransform=xform;ui.style.MozTransformOrigin=origin;if(typeof onResize==="function"){_ch_safeApply(onResize)}}var _ch_activeKey={};function _ch_onClick(event){if(_ch_mode===_ch_PLAY&&typeof onClick==="function"){var c=_ch_getEventCoordinates(event);_ch_safeApply(onClick,c.x,c.y)}else if(_ch_mode===_ch_TITLE){_ch_mode=_ch_SETUP}event.preventDefault()}function _ch_onWheel(event){if(_ch_mode===_ch_PLAY&&typeof onWheel==="function"){var c=_ch_getEventCoordinates(event);var dx=event.deltaX,dy=event.deltaY;if(event.deltaMode===1){dx*=40;dy*=40}else if(event.deltaMode===2){dx*=screenWidth;dy*=screenHeight}_ch_safeApply(onWheel,c.x,c.y,dx,dy)}event.preventDefault()}function _ch_onMouseDown(event){if(_ch_isMobile){event.preventDefault();return false}if(_ch_recentTouchList.wasRecent(event)){event.preventDefault();return false}var touchID=_ch_MOUSETOUCH_IDENTIFIER+event.button;_ch_activeTouchIDSet[touchID]=event;if(_ch_mode===_ch_PLAY){var c=_ch_getEventCoordinates(event);var startedOnTouchKey=_ch_touchKeySet.onTouchStart(c.x,c.y,touchID);event.startedOnTouchKey=startedOnTouchKey;if(!startedOnTouchKey&&typeof onTouchStart==="function"){_ch_safeApply(onTouchStart,c.x,c.y,touchID)}}}function _ch_onWindowMouseUp(event){var touchID=_ch_MOUSETOUCH_IDENTIFIER+event.button;if(_ch_activeTouchIDSet[touchID]){_ch_onMouseUp(event)}else{_ch_activeTouchIDSet[touchID]=false}}function _ch_onWindowTouchEnd(event){var anyOn=false;for(var i=0;i<event.changedTouches.length;++i){var t=event.changedTouches[i];anyOn=anyOn||_ch_activeTouchIDSet[t.identifier]}if(anyOn){_ch_onTouchEnd(event)}for(var i=0;i<event.changedTouches.length;++i){var t=event.changedTouches[i];_ch_activeTouchIDSet[t.identifier]=false}}function _ch_onMouseUp(event){if(_ch_isMobile){event.preventDefault();return false}if(_ch_recentTouchList.wasRecent(event)){event.preventDefault();return}_ch_processSoundLoadQueue();var touchID=_ch_MOUSETOUCH_IDENTIFIER+event.button;_ch_activeTouchIDSet[touchID]=false;if(_ch_mode===_ch_PLAY){var c=_ch_getEventCoordinates(event);if(!_ch_touchKeySet.onTouchEnd(c.x,c.y,touchID)&&typeof onTouchEnd==="function"){_ch_safeApply(onTouchEnd,c.x,c.y,touchID)}}event.stopPropagation()}function _ch_getElementPosition(element){var pos={x:0,y:0};if(element.offsetParent)do{pos.x+=element.offsetLeft;pos.y+=element.offsetTop}while(element=element.offsetParent);return pos}function _ch_getEventCoordinates(event){if(event.target===ui){return{x:Math.round((event.clientX-event.target.offsetLeft)/_ch_zoom),y:Math.round((event.clientY-event.target.offsetTop)/_ch_zoom)}}else{var offset=_ch_getElementPosition(ui);return{x:Math.round((event.clientX-offset.x)/_ch_zoom),y:Math.round((event.clientY-offset.y)/_ch_zoom)}}}function _ch_getTouchCoordinates(touch){return _ch_getEventCoordinates(touch)}function _ch_onMouseMove(event){if(_ch_isMobile){event.preventDefault();return false}if(_ch_recentTouchList.wasRecent(event)){event.preventDefault();return}if(_ch_mode===_ch_PLAY){var c=_ch_getEventCoordinates(event);if(typeof onMouseMove==="function"){_ch_safeApply(onMouseMove,c.x,c.y)}var originalTouch=_ch_activeTouchIDSet[_ch_MOUSETOUCH_IDENTIFIER]||_ch_activeTouchIDSet[_ch_MOUSETOUCH_IDENTIFIER+2];if(originalTouch){for(var i=0;i<2;++i){originalTouch=_ch_activeTouchIDSet[_ch_MOUSETOUCH_IDENTIFIER+2*i];if(originalTouch){if(!originalTouch.startedOnTouchKey&&!_ch_touchKeysEndDrag){if(typeof onTouchMove==="function"){_ch_safeApply(onTouchMove,c.x,c.y,_ch_MOUSETOUCH_IDENTIFIER+2*i)}}else{var r=_ch_touchKeySet.onTouchMove(c.x,c.y,_ch_MOUSETOUCH_IDENTIFIER+2*i);if(!originalTouch.startedOnTouchKey||_ch_touchKeysEndDrag){if(r.simulateTouchStart&&typeof onTouchStart==="function"){_ch_safeApply(onTouchStart,c.x,c.y,_ch_MOUSETOUCH_IDENTIFIER+2*i)}if(r.simulateTouchEnd&&typeof onTouchEnd==="function"){_ch_safeApply(onTouchEnd,c.x,c.y,_ch_MOUSETOUCH_IDENTIFIER+2*i)}if(!r.consumed&&typeof onTouchMove==="function"){_ch_safeApply(onTouchMove,c.x,c.y,_ch_MOUSETOUCH_IDENTIFIER+2*i)}}}}}}}event.preventDefault()}function _ch_onKeyDown(event){if(document.activeElement.tagName==="INPUT"){return}var key=event.keyCode;if(!_ch_activeKey[key]){_ch_activeKey[key]=true;if(_ch_mode===_ch_TITLE){_ch_mode=_ch_SETUP}else if(_ch_mode===_ch_PLAY&&typeof onKeyStart==="function"){_ch_safeApply(onKeyStart,key)}}if(event.preventDefault!==undefined){if(!((event.metaKey||event.ctrlKey)&&(event.keyCode===asciiCode("W")||event.keyCode===asciiCode("R")||event.keyCode===asciiCode("Q")||event.keyCode===asciiCode("T")||event.keyCode===asciiCode("N"))||event.keyCode===116||event.keyCode===123)){event.preventDefault()}}}function _ch_onKeyUp(event){if(document.activeElement.tagName==="INPUT"){return}var key=event.keyCode;_ch_activeKey[key]=false;if(_ch_mode===_ch_PLAY&&typeof onKeyEnd==="function"){_ch_safeApply(onKeyEnd,key)}if(event.preventDefault!==undefined){event.preventDefault()}}function _ch_onTouchStart(event){_ch_processSoundLoadQueue();for(var i=0;i<event.changedTouches.length;++i){var t=event.changedTouches[i];var c=_ch_getTouchCoordinates(t);_ch_activeTouchIDSet[t.identifier]=t;if(_ch_mode===_ch_PLAY){var startedOnTouchKey=_ch_touchKeySet.onTouchStart(c.x,c.y,t.identifier);t.startedOnTouchKey=startedOnTouchKey;if(!startedOnTouchKey&&typeof onTouchStart==="function"){_ch_safeApply(onTouchStart,c.x,c.y,t.identifier)}}}event.stopPropagation();event.preventDefault()}function _ch_onTouchMove(event){if(_ch_mode===_ch_PLAY){for(var i=0;i<event.changedTouches.length;++i){var t=event.changedTouches[i];var c=_ch_getTouchCoordinates(t);var originalTouch=_ch_activeTouchIDSet[t.identifier];if(originalTouch&&!originalTouch.startedOnTouchKey&&!_ch_touchKeysEndDrag){if(typeof onTouchMove==="function"){_ch_safeApply(onTouchMove,c.x,c.y,t.identifier)}}else{var r=_ch_touchKeySet.onTouchMove(c.x,c.y,t.identifier);if(!originalTouch.startedOnTouchKey||_ch_touchKeysEndDrag){if(r.simulateTouchStart&&typeof onTouchStart==="function"){_ch_safeApply(onTouchStart,c.x,c.y,t.identifier)}if(r.simulateTouchEnd&&typeof onTouchEnd==="function"){_ch_safeApply(onTouchEnd,c.x,c.y,t.identifier)}if(!r.consumed&&typeof onTouchMove==="function"){_ch_safeApply(onTouchMove,c.x,c.y,t.identifier)}}}}}_ch_maybePreventDefault(event)}function _ch_onTouchEnd(event){for(var i=0;i<event.changedTouches.length;++i){var t=event.changedTouches[i];var c=_ch_getTouchCoordinates(t);delete _ch_activeTouchIDSet[t.identifier];if(_ch_mode===_ch_PLAY&&(!_ch_touchKeySet.onTouchEnd(c.x,c.y,t.identifier)&&typeof onTouchEnd==="function")){_ch_safeApply(onTouchEnd,c.x,c.y,t.identifier)}}event.stopPropagation();if(event.changedTouches.length===1){_ch_recentTouchList.add(event.changedTouches[0])}}var _ar_CONTROL_INSTRUCTIONS_FONT="Arial";function drawControlInstructions(y){if(y===undefined){y=screenHeight-570}fillRectangle(0,y,screenWidth,screenHeight-y,makeColor(.25,.25,.25,.9));var x=screenWidth/2;var w=1200;var color="#FFF";var style="36px "+_ar_CONTROL_INSTRUCTIONS_FONT;var line=48;fillText("Keyboard",x-w/2,y+15,color,"bold "+_ar_defaultSmallFontSize+_ar_defaultFont,"left","top");
fillText("Action",x,y+15,color,"bold "+_ar_defaultSmallFontSize+_ar_defaultFont,"center","top");fillText("Gamepad",x+w/2,y+15,color,"bold "+_ar_defaultSmallFontSize+_ar_defaultFont,"right","top");var yy=y+95;gamepadArray[0].controlArray.forEach(function(control){if(control.gamePurpose){fillText(control._keyDescription,x-w/2,yy,color,style,"left","top");fillText(control.gamePurpose,x,yy,color,style,"center","top");fillText(control._buttonDescription,x+w/2,yy,color,style,"right","top");yy+=line}})}var _ch_currentState=null;var _ar_gameTime=0;function gameTime(){return _ar_gameTime}function _ar_bindEventHandlers(){window.onSetup=function(){if(typeof onInit==="function"){onInit()}_ar_uiReleaseTime=currentTime()+_ar_UI_LOCKOUT_TIME};window.onTick=function(){switch(uiMode()){case UIMode.TITLE:if(typeof onTitleDraw==="function"){onTitleDraw()}else{_ch_drawTitleScreen()}break;case UIMode.INSTRUCTIONS:if(typeof onInstructionsDraw==="function"){onInstructionsDraw()}else{_ch_onInstructionsDraw()}break;case UIMode.PLAYING:gamepadArray.forEach(function(gamepad){gamepad.controlArray.forEach(function(control){if(control.isActive&&control.repeatFrames>0&&control.repeatFrames<Infinity){++control._repeatCounter;if(control._repeatCounter>=control.repeatFrames){control._repeatCounter=0;if(typeof onControlRepeat==="function"){onControlRepeat(control)}}}})});_ar_gameTime+=1/targetFramerate;if(typeof onSimulation==="function"){onSimulation()}if(typeof onGameDraw==="function"){onGameDraw()}break;case UIMode.PAUSED:if(typeof onGameDraw==="function"){onGameDraw()}fillRectangle(0,_ar_PAUSED_Y(),screenWidth,500,makeColor(.25,.25,.25,.9));fillText("PAUSED",screenWidth/2,_ar_PAUSED_Y()+150,"#FFF","bold 120px "+_ar_defaultFont,"center","middle");fillText("continue",screenWidth/4,_ar_PAUSED_Y()+350,"#FFF",(_ar_uiPauseChoice?"80px ":"110px ")+_ar_defaultFont,"center","middle");fillText("reset",screenWidth*3/4,_ar_PAUSED_Y()+350,"#FFF",(_ar_uiPauseChoice?"110px ":"80px ")+_ar_defaultFont,"center","middle");strokeRectangle(screenWidth/4-285-(1-_ar_uiPauseChoice)*15,_ar_PAUSED_Y()+290-(1-_ar_uiPauseChoice)*15,570+(1-_ar_uiPauseChoice)*30,120+(1-_ar_uiPauseChoice)*30,"#FFF",7+(1-_ar_uiPauseChoice)*7,50);strokeRectangle(screenWidth*3/4-285-_ar_uiPauseChoice*15,_ar_PAUSED_Y()+290-_ar_uiPauseChoice*15,570+_ar_uiPauseChoice*30,120+_ar_uiPauseChoice*30,"#FFF",7+_ar_uiPauseChoice*7,50);if(!isMobile){drawControlInstructions()}break;case UIMode.GAME_OVER:if(typeof onGameDraw==="function"){onGameDraw()}break}};window._ch_onInstructionsDraw=function(){if(isMobile){setUIMode(UIMode.PLAYING)}else{fillRectangle(0,0,screenWidth,screenHeight,makeColor(.25,.25,.25));fillText(_ch_gameName,screenWidth/2,_ar_PAUSED_Y()+150,"#FFF","bold 120px "+_ar_defaultFont,"center","middle");fillText("controls",screenWidth/2,_ar_PAUSED_Y()+300,"#FFF","100px "+_ar_defaultFont,"center","middle");drawControlInstructions(_ar_PAUSED_Y()+550)}};window.onGamepadMove=function(x,y,stickId,gamepadIndex){var threshold=.5;var gamepad=gamepadArray[gamepadIndex];var rightWasActive=gamepad.right._stickActive;var leftWasActive=gamepad.left._stickActive;var upWasActive=gamepad.up._stickActive;var downWasActive=gamepad.down._stickActive;gamepad.left._stickActive=false;gamepad.right._stickActive=false;gamepad.up._stickActive=false;gamepad.down._stickActive=false;if(x>threshold){gamepad.right._stickActive=true}else if(x<-threshold){gamepad.left._stickActive=true}if(y>threshold){gamepad.down._stickActive=true}else if(y<-threshold){gamepad.up._stickActive=true}if(uiMode()===UIMode.PLAYING){if(rightWasActive&&!gamepad.right._stickActive&&!gamepad.right.isActive){_ar_onControlEnd(gamepad.right)}if(leftWasActive&&!gamepad.left._stickActive&&!gamepad.left.isActive){_ar_onControlEnd(gamepad.left)}if(upWasActive&&!gamepad.up._stickActive&&!gamepad.up.isActive){_ar_onControlEnd(gamepad.up)}if(downWasActive&&!gamepad.down._stickActive&&!gamepad.down.isActive){_ar_onControlEnd(gamepad.down)}}if(!rightWasActive&&gamepad.right._stickActive&&_ar_onAnyKeyStart(gamepad.right)){_ar_onControlStart(gamepad.right)}if(!leftWasActive&&gamepad.left._stickActive&&_ar_onAnyKeyStart(gamepad.left)){_ar_onControlStart(gamepad.left)}if(!upWasActive&&gamepad.up._stickActive&&_ar_onAnyKeyStart(gamepad.up)){_ar_onControlStart(gamepad.up)}if(!downWasActive&&gamepad.down._stickActive&&_ar_onAnyKeyStart(gamepad.down)){_ar_onControlStart(gamepad.down)}};window.onTouchStart=function(x,y,id){if(currentTime()<_ar_uiReleaseTime){return false}switch(uiMode()){case UIMode.TITLE:setUIMode(UIMode.INSTRUCTIONS);break;case UIMode.INSTRUCTIONS:setUIMode(UIMode.PLAYING);break;case UIMode.PAUSED:if(Math.abs(y-(_ar_PAUSED_Y()+350))<90){if(Math.abs(x-screenWidth/4)<120){setUIMode(UIMode.PLAYING)}else if(Math.abs(x-screenWidth*3/4)<250){setUIMode(UIMode.TITLE)}}break;case UIMode.GAME_OVER:setUIMode(UIMode.TITLE);break}};window.onGamepadStart=function(buttonId,gamepadIndex,isDirection){var control=gamepadArray[gamepadIndex]._controlButtonMap[buttonId];if(control&&_ar_onAnyKeyStart(control)){if(!control.isActive){_ar_onControlStart(control)}control._buttonActive=true}};window.onGamepadEnd=function(buttonId,gamepadIndex,isDirection){var control=gamepadArray[gamepadIndex]._controlButtonMap[buttonId];if(control&&control.classicName!=="start"&&control._buttonActive){control._buttonActive=false;if(!control.isActive&&uiMode()===UIMode.PLAYING){_ar_onControlEnd(control)}}};window.onKeyStart=function(key){var control=_ch_controlKeyMap[key];if(control&&_ar_onAnyKeyStart(control)){if(!control.isActive){control._keyActive=true;_ar_onControlStart(control)}else{control._keyActive=true}}};window.onKeyEnd=function(key){var control=_ch_controlKeyMap[key];if(control&&control.classicName!=="start"&&control._keyActive){control._keyActive=false;if(!control.isActive&&uiMode()===UIMode.PLAYING){_ar_onControlEnd(control)}}}}var actualFramerate=30;var _ch_frameTimeArray=makeArray(30);function _ch_mainLoop(){var now=currentTime();var then=_ch_frameTimeArray.shift();_ch_frameTimeArray.push(now);if(then){actualFramerate=round(10*_ch_frameTimeArray.length/(now-then))*.1}if(_ch_pauseWhenUnfocused&&!_ch_hasFocus){return}_ch_processGamepads();if(_ch_mode===_ch_INIT){_ch_mode=_ch_TITLE;if(_ch_isMobile){window.scrollTo(0,0);_ch_onResize(null)}}if(_ch_mode===_ch_TITLE){if(!_ch_showTitleScreen||_ch_gameName===undefined){_ch_mode=_ch_SETUP}else{_ch_drawTitleScreen();if(navigator.getGamepads){var list=navigator.getGamepads();for(var j=0;j<list.length;++j){var gamepad=list[j];if(gamepad){for(var i=0;i<gamepad.buttons.length;++i){if(isNumber(gamepad.buttons[i])){if(gamepad.buttons[i]>.5){_ch_mode=_ch_SETUP}}else if(gamepad.buttons[i].value>.5){_ch_mode=_ch_SETUP}}}}}}}if(_ch_mode===_ch_SETUP){_ch_mode=_ch_PLAY;if(typeof onSetup==="function"){_ch_safeApply(onSetup)}}if(_ch_mode===_ch_PLAY){if(typeof onTick==="function"){_ch_safeApply(onTick)}}}function drawTouchKeys(){_ch_touchKeySet.drawAll()}function _ch_drawTitleScreen(){clearRectangle(0,0,screenWidth,screenHeight);if(_ch_titleScreenImage){drawImage(_ch_titleScreenImage,0,0,screenWidth,screenHeight)}else{fillRectangle(0,0,screenWidth,screenHeight,makeColor(1,1,1));fillText(_ch_gameName,screenWidth/2,screenHeight/2-100,makeColor(.5,.5,.5,1),"200px Arial","center","middle");fillText("by "+_ch_authorName,screenWidth/2,screenHeight/2+200,makeColor(.5,.5,.5,1),"100px Arial","center","middle")}_ch_drawLogo();var message=(_ch_touchScreen()?"Touch":"Click")+" to Play";var c=Math.abs(currentTime()*1e3%2e3-1e3)/1e3;fillText(message,screenWidth/2,screenHeight-100,makeColor(c,c,c,1),"100px Arial","center","bottom")}function _ch_touchScreen(){return _ch_isiOS}function _ch_eriwen_getStackTrace(options){options=options||{guess:true};var ex=options.e||null,guess=!!options.guess;var p=new _ch_eriwen_getStackTrace.implementation,result=p.run(ex);return guess?p.guessAnonymousFunctions(result):result}if(typeof module!=="undefined"&&module.exports){module.exports=_ch_eriwen_getStackTrace}_ch_eriwen_getStackTrace.implementation=function(){};_ch_eriwen_getStackTrace.implementation.prototype={run:function(ex,mode){ex=ex||this.createException();mode=mode||this.mode(ex);if(mode==="other"){return this.other(arguments.callee)}else{return this[mode](ex)}},createException:function(){try{this.undef()}catch(e){return e}},mode:function(e){if(e["arguments"]&&e.stack){return"chrome"}else if(e.stack&&e.sourceURL){return"safari"}else if(e.stack&&e.number){return"ie"}else if(typeof e.message==="string"&&typeof window!=="undefined"&&window.opera){if(!e.stacktrace){return"opera9"}if(e.message.indexOf("\n")>-1&&e.message.split("\n").length>e.stacktrace.split("\n").length){return"opera9"}if(!e.stack){return"opera10a"}if(e.stacktrace.indexOf("called from line")<0){return"opera10b"}return"opera11"}else if(e.stack){return"firefox"}return"other"},instrumentFunction:function(context,functionName,callback){context=context||window;var original=context[functionName];context[functionName]=function instrumented(){callback.call(this,_ch_eriwen_getStackTrace().slice(4));return context[functionName]._instrumented.apply(this,arguments)};context[functionName]._instrumented=original},deinstrumentFunction:function(context,functionName){if(context[functionName].constructor===Function&&context[functionName]._instrumented&&context[functionName]._instrumented.constructor===Function){context[functionName]=context[functionName]._instrumented}},chrome:function(e){var stack=(e.stack+"\n").replace(/^\S[^\(]+?[\n$]/gm,"").replace(/^\s+(at eval )?at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,"{anonymous}()@$1$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}()@$1").split("\n");stack.pop();return stack},safari:function(e){return e.stack.replace(/\[native code\]\n/m,"").replace(/^(?=\w+Error\:).*$\n/m,"").replace(/^@/gm,"{anonymous}()@").split("\n")},ie:function(e){var lineRE=/^.*at (\w+) \(([^\)]+)\)$/gm;return e.stack.replace(/at Anonymous function /gm,"{anonymous}()@").replace(/^(?=\w+Error\:).*$\n/m,"").replace(lineRE,"$1@$2").split("\n")},firefox:function(e){return e.stack.replace(/(?:\n@:0)?\s+$/m,"").replace(/^[\(@]/gm,"{anonymous}()@").split("\n")},opera11:function(e){var ANON="{anonymous}",lineRE=/^.*line (\d+), column (\d+)(?: in (.+))? in (\S+):$/;var lines=e.stacktrace.split("\n"),result=[];for(var i=0,len=lines.length;i<len;i+=2){var match=lineRE.exec(lines[i]);if(match){var location=match[4]+":"+match[1]+":"+match[2];var fnName=match[3]||"global code";fnName=fnName.replace(/<anonymous function: (\S+)>/,"$1").replace(/<anonymous function>/,ANON);result.push(fnName+"@"+location+" -- "+lines[i+1].replace(/^\s+/,""))}}return result},opera10b:function(e){var lineRE=/^(.*)@(.+):(\d+)$/;var lines=e.stacktrace.split("\n"),result=[];for(var i=0,len=lines.length;i<len;i++){var match=lineRE.exec(lines[i]);if(match){var fnName=match[1]?match[1]+"()":"global code";result.push(fnName+"@"+match[2]+":"+match[3])}}return result},opera10a:function(e){var ANON="{anonymous}",lineRE=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i;var lines=e.stacktrace.split("\n"),result=[];for(var i=0,len=lines.length;i<len;i+=2){var match=lineRE.exec(lines[i]);if(match){var fnName=match[3]||ANON;result.push(fnName+"()@"+match[2]+":"+match[1]+" -- "+lines[i+1].replace(/^\s+/,""))}}return result},opera9:function(e){var ANON="{anonymous}",lineRE=/Line (\d+).*script (?:in )?(\S+)/i;var lines=e.message.split("\n"),result=[];for(var i=2,len=lines.length;i<len;i+=2){var match=lineRE.exec(lines[i]);if(match){result.push(ANON+"()@"+match[2]+":"+match[1]+" -- "+lines[i+1].replace(/^\s+/,""))}}return result},other:function(curr){var ANON="{anonymous}",fnRE=/function\s*([\w\-$]+)?\s*\(/i,stack=[],fn,args,maxStackSize=10;while(curr&&curr["arguments"]&&stack.length<maxStackSize){fn=fnRE.test(curr.toString())?RegExp.$1||ANON:ANON;args=Array.prototype.slice.call(curr["arguments"]||[]);stack[stack.length]=fn+"("+this.stringifyArguments(args)+")";curr=curr.caller}return stack},stringifyArguments:function(args){var result=[];var slice=Array.prototype.slice;for(var i=0;i<args.length;++i){var arg=args[i];if(arg===undefined){result[i]="undefined"}else if(arg===null){result[i]="null"}else if(arg.constructor){if(arg.constructor===Array){if(arg.length<3){result[i]="["+this.stringifyArguments(arg)+"]"}else{result[i]="["+this.stringifyArguments(slice.call(arg,0,1))+"..."+this.stringifyArguments(slice.call(arg,-1))+"]"}}else if(arg.constructor===Object){result[i]="#object"}else if(arg.constructor===Function){result[i]="#function"}else if(arg.constructor===String){result[i]='"'+arg+'"'}else if(arg.constructor===Number){result[i]=arg}}}return result.join(",")},sourceCache:{},ajax:function(url){var req=this.createXMLHTTPObject();if(req){try{req.open("GET",url,false);req.send(null);return req.responseText}catch(e){}}return""},createXMLHTTPObject:function(){var xmlhttp,XMLHttpFactories=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];for(var i=0;i<XMLHttpFactories.length;i++){try{xmlhttp=XMLHttpFactories[i]();this.createXMLHTTPObject=XMLHttpFactories[i];return xmlhttp}catch(e){}}},isSameDomain:function(url){return typeof location!=="undefined"&&url.indexOf(location.hostname)!==-1},getSource:function(url){if(!(url in this.sourceCache)){this.sourceCache[url]=this.ajax(url).split("\n")}return this.sourceCache[url]},guessAnonymousFunctions:function(stack){for(var i=0;i<stack.length;++i){var reStack=/\{anonymous\}\(.*\)@(.*)/,reRef=/^(.*?)(?::(\d+))(?::(\d+))?(?: -- .+)?$/,frame=stack[i],ref=reStack.exec(frame);if(ref){var m=reRef.exec(ref[1]);if(m){var file=m[1],lineno=m[2],charno=m[3]||0;if(file&&this.isSameDomain(file)&&lineno){var functionName=this.guessAnonymousFunction(file,lineno,charno);stack[i]=frame.replace("{anonymous}",functionName)}}}}return stack},guessAnonymousFunction:function(url,lineNo,charNo){var ret;try{ret=this.findFunctionName(this.getSource(url),lineNo)}catch(e){ret="getSource failed with url: "+url+", exception: "+e.toString()}return ret},findFunctionName:function(source,lineNo){var reFunctionDeclaration=/function\s+([^(]*?)\s*\(([^)]*)\)/;var reFunctionExpression=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*function\b/;var reFunctionEvaluation=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*(?:eval|new Function)\b/;var code="",line,maxLines=Math.min(lineNo,20),m,commentPos;for(var i=0;i<maxLines;++i){line=source[lineNo-i-1];commentPos=line.indexOf("//");if(commentPos>=0){line=line.substr(0,commentPos)}if(line){code=line+code;m=reFunctionExpression.exec(code);if(m&&m[1]){return m[1]}m=reFunctionDeclaration.exec(code);if(m&&m[1]){return m[1]}m=reFunctionEvaluation.exec(code);if(m&&m[1]){return m[1]}}}return"(?)"}};function _ch_callStackToString(stack){var formattedStack="";var frame;for(var i=0;i<stack.length;++i){frame=stack[i];if(frame.indexOf("codeheart.js")===-1&&frame.indexOf("_ch_")===-1&&!(_ch_isChrome&&i===0&&frame.indexOf("Error:")!==-1)){formattedStack+=" "+frame+"\n"}}return formattedStack}function _ch_error(message){_ch_stopTimer();throw new Error(message+"\n\n"+_ch_callStackToString(_ch_getStackTrace()))}function _ch_checkID(id){if(typeof id!=="string"||id.length===0||id[0]==="_"){_ch_error("Illegal ID: "+id)}}function _ch_checkArgs(args,count,message){if(args.length<count){_ch_error(message+" requires at least "+count+" arguments.  ")}}function _ch_checkExactArgs(args,count,message){if(args.length!==count){_ch_error(message+" requires exactly "+count+" arguments.  ")}}var assert=function(test,message){if(!test){_ch_error(message||"")}};var _ch_LONG_LENGTH=1920;var _ch_SHORT_LENGTH=1280;function _ch_setAspectRatioFromWindow(){var w,h;if(window&&window.innerWidth){w=window.innerWidth;h=window.innerHeight}else{w=document.body.clientWidth;h=document.body.clientHeight}_ch_SHORT_LENGTH=1280;_ch_LONG_LENGTH=Math.ceil(_ch_SHORT_LENGTH*Math.max(w,h)/Math.min(w,h))}function _ch_setOrientation(){if(toUpperCase(_ch_orientation)==="V"){screenWidth=_ch_SHORT_LENGTH;screenHeight=_ch_LONG_LENGTH}else{screenWidth=_ch_LONG_LENGTH;screenHeight=_ch_SHORT_LENGTH}canvas.width=screenWidth;canvas.height=screenHeight;_ch_onResize(null)}var _ch_alreadyIncludedList=[];function include(url){_ch_checkExactArgs(arguments,1,"include(url)");if(url.indexOf(">")!==-1||url.indexOf("<")!==-1){_ch_error('"'+url+'" is not a legal URL for include()')}if(url.length<3||url.substring(url.length-3,url.length)!==".js"){_ch_error('The url for include("'+url+'") must end in ".js"')}if(_ch_mode!==_ch_INIT){_ch_error("Can only call include() at the top level before the game begins.")}if(_ch_alreadyIncludedList.indexOf(url)===-1){_ch_alreadyIncludedList.push(url);document.write('<script>_ch_currentScript = "'+url+'";</script>"'+"<script src='"+url+"' charset='utf-8'></script>"+'<script>_ch_currentScript = "'+_ch_currentScript+'";</script>'+"<script src='"+_ch_currentScript+"'></script>");_ch_inInclude=true;throw new function Include(){}}}var _ch_currentScript="game.js";var _ch_inInclude=false;window.onerror=function(e){if(_ch_inInclude){_ch_inInclude=false;return true}else{return false}};function setTouchKeyRectangle(keyCode,x,y,width,height,label){_ch_checkArgs(arguments,5,"setTouchKeyRectangle(keyCode, x, y, width, height, <label>)");_ch_touchKeySet.set(keyCode,x,y,width,height,0,label)}function setTouchKeyCircle(keyCode,x,y,radius,label){_ch_checkArgs(arguments,4,"setTouchKeyRectangle(keyCode, x, y, radius, <label>)");_ch_touchKeySet.set(keyCode,x,y,0,0,radius,label)}function removeTouchKey(keyCode){_ch_checkExactArgs(arguments,1,"removeTouchKey(keyCode)");_ch_touchKeySet.remove(keyCode)}function defineFont(name,url){_ch_checkExactArgs(arguments,2,"defineFont(name, url)");if(_ch_mode!==_ch_INIT){_ch_error("Can only call defineFont() at the top level before the game begins.")}if(_ch_definedFonts.indexOf(name)===-1){document.write("<style>@font-face { font-family: '"+name+"'; src: url('"+url+".woff') format('woff'), url('"+url+".ttf') format('truetype'); }</style>");document.write("<div style=\"font-family: '"+name+"'; position: absolute; left: -100px; top: -100px\">.</div>");_ch_definedFonts.push(name)}}var _ch_definedFonts=[];var _ar_defaultSmallFontSize="65px ";var _ar_defaultFont="sans-serif";function defineGame(gameName,authorName,titleScreenURL,orientation,showTitleScreen,pauseWhenUnfocused,maxResolution,touchKeyDragBehavior,targetFramerate,interactionMode,defaultFont,pixelate){_ch_checkArgs(arguments,2,"defineGame(gameName, authorName, <titleScreenURL>, <orientation>, <showTitleScreen>, <pauseWhenUnfocused>, <maxResolution>, <touchKeyDragBehavior>, <targetFramerate>, <interactionMode>, <defaultArcadeFont>, <pixelate>)");if(_ch_mode!==_ch_INIT){_ch_error("Can only call defineGame() at the top level before the game begins.")}if(interactionMode==="arcade"){showTitleScreen=false}_ch_targetFramerate=targetFramerate||30;_ch_showTitleScreen=showTitleScreen===undefined||showTitleScreen;_ch_pauseWhenUnfocused=pauseWhenUnfocused===undefined||pauseWhenUnfocused;_ch_pixelate=pixelate||false;if(_ch_pixelate){canvas.style.imageRendering="optimizeSpeed";canvas.style.imageRendering="-o-crisp-edges";canvas.style.imageRendering="-moz-crisp-edges";canvas.style.imageRendering="-webkit-optimize-contrast";canvas.style.imageRendering="optimize-contrast";canvas.style.imageRendering="crisp-edges";canvas.style.msInterpolationMode="nearest-neighbor";canvas.style.imageRendering="pixelated"}if(touchKeyDragBehavior===undefined){touchKeyDragBehavior="touch keys end drag"}switch(touchKeyDragBehavior){case"touch keys end drag":_ch_touchKeysEndDrag=true;break;case"drag ignores touch keys":_ch_touchKeysEndDrag=false;break;default:_ch_error('touchKeyDragBehavior argument must be either "touch keys end drag" or "drag ignores touch keys"')}titleScreenURL=titleScreenURL===undefined?"":titleScreenURL;orientation=orientation===undefined?"H":orientation;_ch_maxResolution=maxResolution===undefined?isMobile?"auto":1280:maxResolution;interactionMode=interactionMode===undefined?"full":interactionMode;defaultFont=defaultFont===undefined?"sans-serif":defaultFont;if(orientation!=="H"&&orientation!=="V"){_ch_error('orientation must be either "H" or "V"')}if(isBoolean(_ch_maxResolution)||_ch_maxResolution<=0){_ch_error('maxResolution must be either "auto" or a positive Number')}if(interactionMode!=="full"&&interactionMode!=="arcade"){_ch_error('interactionMode must be either "full" or "arcade"')}if(!isString(defaultFont)){_ch_error("defaultFont must be a String")}_ar_defaultFont=defaultFont;document.title=gameName;window.parent.document.title=gameName;if(titleScreenURL!==""){_ch_titleScreenImage=loadImage(titleScreenURL)}_ch_gameName=gameName;_ch_authorName=authorName;_ch_orientation=orientation;_ch_setOrientation();if(interactionMode==="arcade"){_ar_bindEventHandlers()}}function UIMode(value){console.assert(UIMode._allowValues,"Cannot create new UIMode values");this.value=value;Object.freeze(this)}UIMode.prototype.toString=function(){return this.value};UIMode._allowValues=true;UIMode.TITLE=new UIMode("TITLE");UIMode.INSTRUCTIONS=new UIMode("INSTRUCTIONS");UIMode.PLAYING=new UIMode("PLAYING");UIMode.PAUSED=new UIMode("PAUSED");UIMode.GAME_OVER=new UIMode("GAME_OVER");UIMode._allowValues=false;Object.freeze(UIMode);function Control(classicName,isDirection,key1,key2,keyDescription,button1,button2,buttonDescription,touchKeyLabel,touchKeyStyle,gamepadIndex){this.gamePurpose=undefined;this.gamepadIndex=gamepadIndex;this.touchKeyLabel=touchKeyLabel;this.touchKeyStyle=touchKeyStyle;Object.defineProperties(this,{classicName:{value:classicName},isDirection:{value:isDirection},_key1:{value:key1},_key2:{value:key2},_keyDescription:{value:keyDescription},_button1:{value:button1},_button2:{value:button2},_buttonDescription:{value:buttonDescription}});this._keyActive=false;this._buttonActive=false;this._stickActive=false;this._repeatCounter=0;this.repeatFrames=Infinity;this.delayFrames=10;_ch_controlKeyMap[key1]=_ch_controlKeyMap[key2]=this;Object.seal(this)}Object.defineProperty(Control.prototype,"isActive",{get:function(){return this._keyActive||this._buttonActive||this._stickActive}});Object.freeze(Control);function Gamepad(index,left,up,right,down,start,select,A,B,X,Y){this.index=index;this._present=index===0;this.left=left;this.up=up;this.right=right;this.down=down;this.start=start;this.select=select;this.A=A;this.B=B;this.X=X;this.Y=Y;this.controlArray=Object.freeze([up,down,left,right,A,B,X,Y,start,select]);this._controlButtonMap=[];for(var i=0;i<this.controlArray.length;++i){var control=this.controlArray[i];this._controlButtonMap[control._button1]=this._controlButtonMap[control._button2]=control}Object.freeze(this)}Gamepad.prototype.currentDirection=function(){var x=0,y=0;if(this.left.isActive){--x}if(this.right.isActive){++x}if(this.up.isActive){--y}if(this.down.isActive){++y}return vec2(x,y)};Object.defineProperty(Gamepad.prototype,"present",{get:function(){return this.present}});Object.freeze(Gamepad);var gamepadArray=[new Gamepad(0,new Control("left",true,asciiCode("A"),37,"A or \u2190",GAMEPAD.BUTTON.DPAD_LEFT,undefined,"\u2190","\u25c0","bold 70px Arial",0),new Control("up",true,asciiCode("W"),38,"W or \u2191",GAMEPAD.BUTTON.DPAD_UP,undefined,"\u2191","\u25b2","bold 70px Arial",0),new Control("right",true,asciiCode("D"),39,"D or \u2192",GAMEPAD.BUTTON.DPAD_RIGHT,undefined,"\u2192","\u25b6","bold 70px Arial",0),new Control("down",true,asciiCode("S"),40,"S or \u2193",GAMEPAD.BUTTON.DPAD_DOWN,undefined,"\u2193","\u25bc","bold 70px Arial",0),new Control("start",false,27,undefined,"Esc",GAMEPAD.BUTTON.START,undefined,"Start","| |","bold 90px Arial",0),new Control("select",false,8,9,"Tab or Bks",GAMEPAD.BUTTON.SELECT,undefined,"Select","\u25b1","bold 90px Arial",0),new Control("A",false,asciiCode(" "),asciiCode("K"),"K or Spacebar",GAMEPAD.BUTTON.A,GAMEPAD.BUTTON.LEFT_SHOULDER,"A","\u27c1","bold 140px Arial",0),new Control("B",false,13,asciiCode("L"),"L or Enter",GAMEPAD.BUTTON.B,GAMEPAD.BUTTON.RIGHT_SHOULDER,"B","\u2295","180px Arial",0),new Control("X",false,asciiCode("J"),16,"J or Shift",GAMEPAD.BUTTON.X,undefined,"X","\u29be","180px Arial",0),new Control("Y",false,asciiCode("I"),17,"I or Control",GAMEPAD.BUTTON.Y,undefined,"Y","\u27d0","190px Arial",0))];gamepadArray[0].start.gamePurpose="Pause";Object.freeze(gamepadArray[0].start);(function(){for(var i=1;i<=3;++i){insertBack(gamepadArray,new Gamepad(i,new Control("left",true,undefined,undefined,"",GAMEPAD.BUTTON.DPAD_LEFT,undefined,"\u2190","\u25c0","bold 70px Arial",i),new Control("up",true,undefined,undefined,"",GAMEPAD.BUTTON.DPAD_UP,undefined,"\u2191","\u25b2","bold 70px Arial",i),new Control("right",true,undefined,undefined,"",GAMEPAD.BUTTON.DPAD_RIGHT,undefined,"\u2192","\u25b6","bold 70px Arial",i),new Control("down",true,undefined,undefined,"",GAMEPAD.BUTTON.DPAD_DOWN,undefined,"\u2193","\u25bc","bold 70px Arial",i),new Control("start",false,undefined,undefined,"",GAMEPAD.BUTTON.START,undefined,"Start","| |","bold 90px Arial",i),new Control("select",false,undefined,undefined,"",GAMEPAD.BUTTON.SELECT,undefined,"Select","\u25b1","bold 90px Arial",i),new Control("A",false,undefined,undefined,"",GAMEPAD.BUTTON.A,GAMEPAD.BUTTON.LEFT_SHOULDER,"A","\u27c1","bold 140px Arial",i),new Control("B",false,undefined,undefined,"",GAMEPAD.BUTTON.B,GAMEPAD.BUTTON.RIGHT_SHOULDER,"B","\u2295","180px Arial",i),new Control("X",false,undefined,undefined,"",GAMEPAD.BUTTON.X,undefined,"X","\u29be","180px Arial",i),new Control("Y",false,undefined,undefined,"",GAMEPAD.BUTTON.Y,undefined,"Y","\u27d0","190px Arial",i)))}})();Object.freeze(gamepadArray);Object.freeze(_ch_controlKeyMap);var _ar_uiMode=UIMode.TITLE;var _ar_uiPauseChoice=0;var _ar_UI_LOCKOUT_TIME=.8;var _ar_uiReleaseTime=0;var _ar_NUM_HIGH_SCORES=10;function uiMode(){return _ar_uiMode}function setUIMode(newMode,score,displayScore){_ch_checkArgs(arguments,1,"setUIMode(newMode, <score>, <displayScore>)");if(newMode!==UIMode.GAME_OVER&&arguments.length>1){_ch_error("score only permitted in UIMode.GAME_OVER")}if(newMode!==UIMode.TITLE&&newMode!==UIMode.INSTRUCTIONS&&newMode!==UIMode.PLAYING&&newMode!==UIMode.PAUSED&&newMode!==UIMode.GAME_OVER){_ch_error("Unrecognized UIMode used for setUIMode: '"+newMode+"'")}var oldMode=_ar_uiMode;if(typeof onUIModeChange==="function"){onUIModeChange(_ar_uiMode,newMode);if(oldMode!==_ar_uiMode){return}}if(newMode===UIMode.PAUSED){_ar_uiPauseChoice=0}if(newMode!==UIMode.PLAYING){_ar_uiReleaseTime=currentTime()+_ar_UI_LOCKOUT_TIME}if(newMode===UIMode.PLAYING&&isMobile){_ar_setTouchKeys()}else{_ar_removeTouchKeys()}if((_ar_uiMode===UIMode.INSTRUCTIONS||_ar_uiMode===UIMode.TITLE||_ar_uiMode===UIMode.GAME_OVER)&&newMode===UIMode.PLAYING&&typeof onGameStart==="function"){_ar_uiMode=newMode;_ar_gameTime=0;onGameStart()}else{_ar_uiMode=newMode}if(newMode===UIMode.GAME_OVER&&oldMode===UIMode.PLAYING&&score!==undefined){if(!isNumber(score)){_ch_error("score must be a Number")}if(displayScore===undefined){displayScore=""+numberWithCommas(score)}else if(!isString(displayScore)){_ch_error("displayScore must be a string")}_ar_endGame(score,displayScore)}}function _ar_endGame(score,displayScore){var highScoreArray=_ar_loadHighScoreArray();var i=0;while(i<highScoreArray.length&&highScoreArray[i].score>score){++i}if(i<highScoreArray.length){name=prompt("New High Score of "+displayScore+"!\n\nEnter your name (max. 5 letters):","AAA");if(name){name=name.substring(0,5);insertAt(highScoreArray,i,{score:score,displayScore:displayScore,name:name,date:(new Date).toISOString().substring(0,10)});while(highScoreArray.length>_ar_NUM_HIGH_SCORES){highScoreArray.pop()}_ar_saveHighScoreArray(highScoreArray)}}}function _ar_loadHighScoreArray(){var highScoreArray=localStorage[_ch_gameName+"_highScoreArray"];if(highScoreArray===undefined){highScoreArray='[{"name":"SAM", "score":0, "displayScore":"0", "date":"2015-11-14"}, {"name":"\u2764\u2764\u2764", "score":1, "displayScore":"1", "date":"2015-11-16"},{"name":"Diddy", "score":2, "displayScore":"2", "date":"2015-11-14"}]'}highScoreArray=JSON.parse(highScoreArray);highScoreArray.sort(function(a,b){return b.score-a.score});return highScoreArray}function _ar_saveHighScoreArray(a){localStorage[_ch_gameName+"_highScoreArray"]=JSON.stringify(a)}function drawHighScores(y0,height,color,outlineColor){if(y0===undefined){y0=0}if(height===undefined){height=screenHeight-y0}if(color===undefined){color="#000"}var highScoreArray=_ar_loadHighScoreArray();var lineHeight=70;var x=screenWidth/2;var w=900;var style=_ar_defaultSmallFontSize+_ar_defaultFont;fillText("Best Scores",x,y0,color,style,"center","middle");_ch_ctx.save();var scrollDistance=max(0,highScoreArray.length*lineHeight-(height-lineHeight*1.5));_ch_ctx.beginPath();_ch_ctx.rect(x-w/2,y0+lineHeight,w,height-lineHeight);_ch_ctx.clip();var offset=min(max(sin((_ar_scrollTimeOffset-currentTime())*.5)*1.1,0),1);for(var y=y0+lineHeight*1.5-offset*scrollDistance,i=0;i<highScoreArray.length&&y<y0+height+lineHeight;y+=lineHeight,++i){var h=highScoreArray[i];var d=h.displayScore;if(d===undefined){d=numberWithCommas(h.score)}if(outlineColor!==undefined){strokeText("#"+(i+1),x-w/2,y,outlineColor,style,5,"left","middle");strokeText(h.name,x,y,outlineColor,style,5,"center","middle");strokeText(d,x+w/2,y,outlineColor,style,5,"right","middle")}fillText("#"+(i+1),x-w/2,y,color,style,"left","middle");fillText(h.name,x,y,color,style,"center","middle");fillText(d,x+w/2,y,color,style,"right","middle")}_ch_ctx.restore()}function drawArcadeTouchKeys(){var TOUCH_KEY_COLOR="#555";var ACTIVE_TOUCH_KEY_COLOR="#AA0";gamepadArray[0].controlArray.forEach(function(control){var touchKey=_ch_touchKeySet.list[_ch_touchKeySet.find(control._key1)];if(touchKey){var x,y;if(touchKey.width){x=touchKey.x+touchKey.width/2;y=touchKey.y+touchKey.height/2}else{x=touchKey.x;y=touchKey.y}fillText(touchKey.label,x,y,touchKey.activeTouchIDs.length?ACTIVE_TOUCH_KEY_COLOR:TOUCH_KEY_COLOR,control.touchKeyStyle,"center","middle")}})}function _ar_setTouchKeys(){var TOUCH_KEY_X=250;var TOUCH_KEY_Y=screenHeight*2/3;var TOUCH_KEY_RADIUS=100;var upY=TOUCH_KEY_Y-TOUCH_KEY_RADIUS*2.25;var downY=TOUCH_KEY_Y+TOUCH_KEY_RADIUS*.65;var centerY=(upY+downY)/2;var control=gamepadArray[0];if(control.left.gamePurpose)setTouchKeyRectangle(control.left._key1,TOUCH_KEY_X-TOUCH_KEY_RADIUS*2.5,upY,TOUCH_KEY_RADIUS*1.65,TOUCH_KEY_RADIUS*4.5,control.left.touchKeyLabel);if(control.right.gamePurpose)setTouchKeyRectangle(control.right._key1,TOUCH_KEY_X+TOUCH_KEY_RADIUS*.35,upY,TOUCH_KEY_RADIUS*1.65,TOUCH_KEY_RADIUS*4.5,control.right.touchKeyLabel);if(control.up.gamePurpose)setTouchKeyRectangle(control.up._key1,TOUCH_KEY_X-TOUCH_KEY_RADIUS*2.5,upY,TOUCH_KEY_RADIUS*4.5,TOUCH_KEY_RADIUS*1.65,control.up.touchKeyLabel);if(control.down.gamePurpose)setTouchKeyRectangle(control.down._key1,TOUCH_KEY_X-TOUCH_KEY_RADIUS*2.5,downY,TOUCH_KEY_RADIUS*4.5,TOUCH_KEY_RADIUS*1.65,control.down.touchKeyLabel);if(control.B.gamePurpose)setTouchKeyCircle(control.B._key1,screenWidth-TOUCH_KEY_X+TOUCH_KEY_RADIUS*1.45,centerY+TOUCH_KEY_RADIUS*1.65/2,TOUCH_KEY_RADIUS,control.B.touchKeyLabel);if(control.A.gamePurpose)setTouchKeyCircle(control.A._key1,screenWidth-TOUCH_KEY_X+TOUCH_KEY_RADIUS*.05,downY+TOUCH_KEY_RADIUS*1.65/2,TOUCH_KEY_RADIUS,control.A.touchKeyLabel);if(control.Y.gamePurpose)setTouchKeyCircle(control.Y._key1,screenWidth-TOUCH_KEY_X+TOUCH_KEY_RADIUS*.05,upY+TOUCH_KEY_RADIUS*1.65/2,TOUCH_KEY_RADIUS,control.Y.touchKeyLabel);if(control.X.gamePurpose)setTouchKeyCircle(control.X._key1,screenWidth-TOUCH_KEY_X-TOUCH_KEY_RADIUS*1.35,centerY+TOUCH_KEY_RADIUS*1.65/2,TOUCH_KEY_RADIUS,control.X.touchKeyLabel);if(control.select.gamePurpose)setTouchKeyRectangle(control.select._key1,0,0,TOUCH_KEY_RADIUS*1.5,TOUCH_KEY_RADIUS*1.5,control.select.touchKeyLabel);setTouchKeyRectangle(control.start._key1,screenWidth-TOUCH_KEY_RADIUS*1.5,0,TOUCH_KEY_RADIUS*1.5,TOUCH_KEY_RADIUS*1.5,control.start.touchKeyLabel);
}function _ar_removeTouchKeys(){gamepadArray[0].controlArray.forEach(function(control){removeTouchKey(control._key1)})}var currentTime=window.performance&&window.performance.now?function(){return(window.performance.now()+window.performance.timing.navigationStart)*.001}:function(){return Date.now()*.001};var _ar_scrollTimeOffset=currentTime();function reset(){_ch_checkExactArgs(arguments,0,"reset()");if(_ch_mode!==_ch_PLAY&&_ch_mode!==_ch_SETUP){_ch_error("Can only call returnToTitleScreen() after the game has started")}_ch_mode=_ch_SETUP}function asciiCode(s){_ch_checkExactArgs(arguments,1,"asciiCode(s)");if(s.length!==1){_ch_error("asciiCode requires a string of exactly one character")}return s.charCodeAt(0)}function asciiCharacter(n){_ch_checkExactArgs(arguments,1,"asciiCharacter(n)");if(typeof n!=="number"||n!==Math.floor(n)||n<0||n>255){_ch_error("asciiCharacter requires an integer between 0 and 255")}return String.fromCharCode(n)}function randomReal(low,high,rng){_ch_checkArgs(arguments,2,"randomReal(low, high, <rng>)");if(isNaN(low)||isNaN(high)||low>high||!isNumber(low)||!isNumber(high)||low===-Infinity||high===+Infinity){_ch_error("low must be no greater than high and both must be finite numbers")}var r=rng?rng():Math.random();return r*(high-low)+low}function randomInteger(low,high,rng){_ch_checkArgs(arguments,2,"randomInteger(low, high, <rng>)");return Math.min(high,floor(randomReal(low,high+1,rng)))}function floor(v){return _ch_vecApply("floor",Math.floor,v)}function ceil(v){return _ch_vecApply("ceil",Math.ceil,v)}var abs=function(x){return _ch_vecApply("abs",Math.abs,x)};var cos=Math.cos;var sin=Math.sin;function frac(x){return x-Math.floor(x)}function numberWithCommas(x){_ch_checkArgs(arguments,1,"numberWithCommas(x)");if(!isNumber(x)){_ch_error("Argument must be a Number")}return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function randomizeArray(array){_ch_checkArgs(arguments,1,"randomizeArray(array)");if(!isArray(array)||array.width!==undefined){_ch_error("Argument must be an Array")}for(var i=array.length-1;i>0;--i){var j=randomInteger(0,i);var temp=array[i];array[i]=array[j];array[j]=temp}}function square(x){return x*x}function clamp(x,low,high){return min(max(x,low),high)}var sign=function(x){return _ch_vecApply("sign",Math.sign,x)};var tan=Math.tan;var atan2=Math.atan2;var log=Math.log;function log2(x){_ch_checkArgs(arguments,1,"log2(x)");return Math.log(x)/Math.log(2)}var round=Math.round;var sqrt=function(x){return _ch_vecApply("sqrt",Math.sqrt,x)};var pow=Math.pow;function max(a,b){switch(arguments.length){case 1:return a;case 2:return _ch_vecApply("max",Math.max,a,b);default:for(var i=1;i<arguments.length;++i){a=_ch_vecApply("max",Math.max,a,arguments[i])}return a}}function min(a,b){switch(arguments.length){case 1:return a;case 2:return _ch_vecApply("max",Math.min,a,b);default:for(var i=1;i<arguments.length;++i){a=_ch_vecApply("max",Math.min,a,arguments[i])}return a}}var exp=Math.exp;function length(x){_ch_checkArgs(arguments,1,"length(x)");return x.length}function cloneArray(x){_ch_checkArgs(arguments,1,"cloneArray(x)");if(x.width!==undefined){_ch_error("Cannot use cloneArray() with a 2D grid")}return x.slice(0)}function forEach(array,fcn){_ch_checkArgs(arguments,2,"forEach(array, fcn)");if(isFunction(array.__forEach)){array.__forEach(fcn);return}if(!isArray(array)||!isFunction(fcn)){_ch_error("forEach takes an array and a function as arguments")}for(var i=0;i<array.length;++i){switch(fcn(array[i],i,array)){case forEach.BREAK:return;case forEach.REMOVE:if(array.length>0){removeAt(array,i);--i}break;case forEach.FAST_REMOVE:if(i!=array.length-1){array[i]=array.pop();--i}else if(array.length>0){array.pop()}break}}}forEach.BREAK=Object.freeze(["BREAK"]);forEach.REMOVE=Object.freeze(["REMOVE"]);forEach.FAST_REMOVE=Object.freeze(["FAST_REMOVE"]);Object.freeze(forEach);function insertFront(array,value){_ch_checkArgs(arguments,2,"insertFront(array, value, ...)");for(var i=arguments.length-1;i>0;--i){array.unshift(arguments[i])}}function insertBack(array,value){_ch_checkArgs(arguments,2,"insertBack(array, value, ...)");for(var i=1;i<arguments.length;++i){array.push(arguments[i])}}function insertAt(array,index,value){_ch_checkArgs(arguments,3,"insertAt(array, index, value, ...)");if(typeof index!=="number"){_ch_error("The index to insertAt must be a number")}if(arguments.length===3){array.splice(index,0,value)}else{var args=[index,0].concat(Array.prototype.slice.call(arguments,2));Array.prototype.splice.apply(array,args)}}function removeAt(array,index){_ch_checkExactArgs(arguments,2,"removeAt(array, index)");if(typeof index!=="number"){_ch_error("The index to removeAt must be a number")}var temp=array[index];array.splice(index,1);return temp}function removeBack(array){_ch_checkExactArgs(arguments,1,"removeBack(array)");return array.pop()}function removeFront(array){_ch_checkExactArgs(arguments,1,"removeFront(array)");return array.shift()}function substring(s,begin,end){_ch_checkExactArgs(arguments,3,"substring(str, begin, end)");return s.substring(begin,end)}function indexOf(s,searchFor,begin){_ch_checkArgs(arguments,2,"indexOf(strOrArray, searchFor, <$1>)");begin=begin===undefined?0:begin;return s.indexOf(searchFor,begin)}function toUpperCase(x){_ch_checkExactArgs(arguments,1,"toUpperCase(str)");return x.toUpperCase()}function toLowerCase(x){_ch_checkExactArgs(arguments,1,"toLowerCase(str)");return x.toLowerCase()}function clearScreen(){_ch_checkExactArgs(arguments,0,"clearScreen()");_ch_ctx.save();_ch_ctx.setTransform(1,0,0,1,0,0);clearRectangle(0,0,screenWidth,screenHeight);_ch_ctx.restore()}function clearRectangle(x0,y0,w,h){_ch_checkArgs(arguments,4,"clearRectangle(x0, y0, w, h)");_ch_ctx.clearRect(x0,y0,w,h)}function fillCircle(x,y,radius,color){_ch_checkArgs(arguments,4,"fillCircle(x, y, radius, color)");_ch_ctx.fillStyle=color;_ch_ctx.beginPath();_ch_ctx.arc(x,y,radius,0,2*Math.PI,true);_ch_ctx.fill()}function strokeCircle(x,y,radius,color,thickness){_ch_checkArgs(arguments,5,"strokeCircle(x, y, radius, color, thickness)");_ch_ctx.lineWidth=thickness;_ch_ctx.strokeStyle=color;_ch_ctx.beginPath();_ch_ctx.arc(x,y,radius,0,2*Math.PI,true);_ch_ctx.stroke()}function fillTriangle(x0,y0,x1,y1,x2,y2,color){_ch_ctx.beginPath();_ch_ctx.moveTo(x0,y0);_ch_ctx.lineTo(x1,y1);_ch_ctx.lineTo(x2,y2);_ch_ctx.closePath();_ch_ctx.fillStyle=color;_ch_ctx.fill()}function strokeTriangle(x0,y0,x1,y1,x2,y2,color,thickness){_ch_ctx.beginPath();_ch_ctx.moveTo(x0,y0);_ch_ctx.lineTo(x1,y1);_ch_ctx.lineTo(x2,y2);_ch_ctx.closePath();_ch_ctx.lineWidth=thickness;_ch_ctx.strokeStyle=color;_ch_ctx.stroke()}function fillRectangle(x0,y0,w,h,color,radius){_ch_checkArgs(arguments,5,"fillRectangle(x0, y0, w, h, color, <radius>)");_ch_ctx.fillStyle=color;if(radius===undefined||radius<=0){_ch_ctx.fillRect(x0,y0,w,h)}else{_ch_roundRectPath(_ch_ctx,x0,y0,w,h,radius);_ch_ctx.fill()}}function fillPolygon(pts,color){_ch_checkArgs(arguments,2,"fillPolygon(pts, color)");if(pts.length<2){return}_ch_ctx.fillStyle=color;_ch_ctx.beginPath();_ch_ctx.moveTo(pts[0],pts[1]);for(var i=2;i<pts.length;i+=2){_ch_ctx.lineTo(pts[i],pts[i+1])}_ch_ctx.closePath();_ch_ctx.fill()}function strokePolygon(pts,color,thickness,close){_ch_checkArgs(arguments,3,"strokePolygon(pts, color, thickness, <close>)");if(pts.length<2){return}_ch_ctx.lineWidth=thickness;_ch_ctx.strokeStyle=color;_ch_ctx.beginPath();_ch_ctx.moveTo(pts[0],pts[1]);for(var i=2;i<pts.length;i+=2){_ch_ctx.lineTo(pts[i],pts[i+1])}if(close){_ch_ctx.closePath()}_ch_ctx.stroke()}function _ch_roundRectPath(ctx,x,y,width,height,radius){ctx.beginPath();ctx.moveTo(x+radius,y);ctx.lineTo(x+width-radius,y);ctx.quadraticCurveTo(x+width,y,x+width,y+radius);ctx.lineTo(x+width,y+height-radius);ctx.quadraticCurveTo(x+width,y+height,x+width-radius,y+height);ctx.lineTo(x+radius,y+height);ctx.quadraticCurveTo(x,y+height,x,y+height-radius);ctx.lineTo(x,y+radius);ctx.quadraticCurveTo(x,y,x+radius,y);ctx.closePath()}function strokeRectangle(x0,y0,w,h,color,thickness,radius){_ch_checkArgs(arguments,6,"strokeRectangle(x0, y0, w, h, color, thickness, <radius>)");if(typeof color==="number"){_ch_error("Color must be a color")}if(typeof thickness!=="number"){_ch_error("Thickness must be a number")}_ch_ctx.lineWidth=thickness;_ch_ctx.strokeStyle=color;if(radius===undefined||radius<=0){_ch_ctx.strokeRect(x0,y0,w,h)}else{_ch_roundRectPath(_ch_ctx,x0,y0,w,h,radius);_ch_ctx.stroke()}}function fillText(text,x,y,color,style,xAlign,yAlign,angle){_ch_checkArgs(arguments,5,"fillText(text, x, y, color, style, <xAlign>, <yAlign>, <angle>)");xAlign=xAlign===undefined?"start":xAlign;yAlign=yAlign===undefined?"alphabetic":yAlign;if(typeof y!=="number"){_ch_error("The y-position argument to fillText must be a number.")}angle=angle||0;_ch_ctx.textAlign=xAlign;_ch_ctx.textBaseline=yAlign;_ch_ctx.font=style;_ch_ctx.fillStyle=color;try{if(angle){_ch_ctx.save();_ch_ctx.translate(x,y);_ch_ctx.rotate(angle);_ch_ctx.fillText(text,0,0);_ch_ctx.restore()}else{_ch_ctx.fillText(text,x,y)}}catch(e){}}function measureTextWidth(text,style){_ch_checkArgs(arguments,2,"measureText(text, style)");_ch_ctx.font=style;return _ch_ctx.measureText(text).width}function strokeText(text,x,y,color,style,thickness,xAlign,yAlign,angle){_ch_checkArgs(arguments,6,"strokeText(text, x, y, color, style, thickness, <xAlign>, <yAlign>, <angle>)");xAlign=xAlign===undefined?"start":xAlign;yAlign=yAlign===undefined?"alphabetic":yAlign;_ch_ctx.lineWidth=thickness;_ch_ctx.textAlign=xAlign;_ch_ctx.textBaseline=yAlign;_ch_ctx.font=style;_ch_ctx.strokeStyle=color;angle=angle||0;if(angle){_ch_ctx.save();_ch_ctx.translate(x,y);_ch_ctx.rotate(angle);_ch_ctx.strokeText(text,0,0);_ch_ctx.restore()}else{_ch_ctx.strokeText(text,x,y)}}function strokeSpline(C,color,thickness,close){_ch_checkArgs(arguments,3,"strokeSpline(controlPoints, color, thickness, <close>)");close=close===undefined?false:close;_ch_ctx.lineWidth=thickness;_ch_ctx.strokeStyle=color;_ch_ctx.beginPath();_ch_splineTo(_ch_ctx,C,close);_ch_ctx.stroke()}function fillSpline(C,color,close){_ch_checkArgs(arguments,2,"fillSpline(controlPoints, color, <close>)");close=close===undefined?false:close;_ch_ctx.fillStyle=color;_ch_ctx.beginPath();_ch_splineTo(_ch_ctx,C,close);_ch_ctx.fill()}function drawImage(image,dstX0,dstY0,dstWidth,dstHeight,srcX0,srcY0,srcWidth,srcHeight,alpha,imageSmoothing){_ch_checkArgs(arguments,1,"drawImage(image, dstX0, <dstY0>, <dstWidth>, <dstHeight>, <srcX0>, <srcY0>, <srcWidth>, <srcHeight>, <alpha>, <imageSmoothing>)");if(image===undefined){_ch_error("You called drawImage with no image! ")}if(dstX0===undefined){dstX0=0}if(dstY0===undefined){dstY0=0}if(dstWidth===undefined){dstWidth=image.width||image.videoWidth}if(dstHeight===undefined){dstHeight=image.height||image.videoHeight}if(srcX0===undefined){srcX0=0}if(srcY0===undefined){srcY0=0}if(srcWidth===undefined){srcWidth=image.width||image.videoWidth}if(srcHeight===undefined){srcHeight=image.height||image.videoHeight}if(alpha===undefined){alpha=1}if(imageSmoothing===undefined){imageSmoothing=!_ch_pixelate}if(image.nodeType===undefined){_ch_error("drawImage requires an image created by loadImage as the first argument.")}var oldAlpha=1;if(alpha!==1){oldAlpha=_ch_ctx.globalAlpha;_ch_ctx.globalAlpha*=alpha}_ch_setImageSmoothing(imageSmoothing);try{_ch_ctx.drawImage(image,srcX0,srcY0,srcWidth,srcHeight,dstX0,dstY0,dstWidth,dstHeight)}catch(e){}if(alpha!==1){_ch_ctx.globalAlpha=oldAlpha}}var _ch_setImageSmoothing=_ch_isSafari?function(imageSmoothing){_ch_ctx.webkitImageSmoothingEnabled=imageSmoothing}:_ch_isChrome?function(imageSmoothing){_ch_ctx.imageSmoothingEnabled=imageSmoothing}:_ch_isFirefox?function(imageSmoothing){_ch_ctx.mozImageSmoothingEnabled=imageSmoothing}:function(imageSmoothing){_ch_ctx.imageSmoothingEnabled=imageSmoothing;_ch_ctx.msImageSmoothingEnabled=imageSmoothing};function drawTransformedImage(image,translateX,translateY,rotate,scaleX,scaleY,sourceX,sourceY,sourceWidth,sourceHeight,alpha,imageSmoothing){_ch_checkArgs(arguments,3,"drawTransformedImage(image, translateX, translateY, <rotate>, <scaleX>, <scaleY>, <sourceX>, <sourceY>, <sourceWidth>, <sourceHeight>, <alpha>, <imageSmoothing>)");if(image===undefined){_ch_error("You called drawTransformedImage with no image! ")}rotate=rotate===undefined?0:rotate;scaleX=scaleX===undefined?1:scaleX;scaleY=scaleY===undefined?1:scaleY;sourceX=sourceX===undefined?0:sourceX;sourceY=sourceY===undefined?0:sourceY;sourceWidth=sourceWidth===undefined?image.width||image.videoWidth:sourceWidth;sourceHeight=sourceHeight===undefined?image.height||image.videoHeight:sourceHeight;alpha=alpha===undefined?1:alpha;if(imageSmoothing===undefined){imageSmoothing=true}_ch_drawTransformedImage(image,translateX,translateY,rotate,scaleX,scaleY,sourceX,sourceY,sourceWidth,sourceHeight,alpha,imageSmoothing)}function _ch_drawTransformedImage(image,translateX,translateY,rotate,scaleX,scaleY,sourceX,sourceY,sourceWidth,sourceHeight,alpha,imageSmoothing){_ch_ctx.save();if(alpha!==1){_ch_ctx.globalAlpha*=alpha}_ch_setImageSmoothing(imageSmoothing);_ch_ctx.translate(translateX,translateY);if(rotate!==0){_ch_ctx.rotate(rotate)}if(scaleX!==1||scaleY!==1){_ch_ctx.scale(scaleX,scaleY)}try{_ch_ctx.drawImage(image,sourceX,sourceY,sourceWidth,sourceHeight,-sourceWidth*.5,-sourceHeight*.5,sourceWidth,sourceHeight)}catch(e){}_ch_ctx.restore()}var _ch_makeTemporaryGradient=function(){var gradientCanvas=document.createElement("canvas");gradientCanvas.width=gradientCanvas.height=2;var gradientContext=gradientCanvas.getContext("2d");var gradientPixels=gradientContext.getImageData(0,0,2,2);var data=gradientPixels.data;return function(r0,g0,b0,a0,r1,g1,b1,a1,r2,g2,b2,a2){data[0]=r0*256;data[1]=g0*256;data[2]=b0*256;data[3]=a0*256;data[4]=r1*256;data[5]=g1*256;data[6]=b1*256;data[7]=a1*256;data[8]=r2*256;data[9]=g2*256;data[10]=b2*256;data[11]=a2*256;data[12]=(r1+r2)*128;data[13]=(g1+g2)*128;data[14]=(b1+b2)*128;data[15]=(a1+a2)*128;gradientContext.putImageData(gradientPixels,0,0);return gradientCanvas}}();function drawGradientTriangle(x0,y0,x1,y1,x2,y2,r0,g0,b0,a0,r1,g1,b1,a1,r2,g2,b2,a2){drawImageTriangle(x0,y0,x1,y1,x2,y2,.5/1.5,.5/1.5,1.5/1.5,.5/1.5,.5/1.5,1.5/1.5,_ch_makeTemporaryGradient(r0,g0,b0,a0,r1,g1,b1,a1,r2,g2,b2,a2))}function _ch_ImagePattern(image){var pattern=this;this.image=image;delete image;function creator(){if(!pattern.image.loaded){setTimeout(creator,5)}else{pattern.pattern=document.createElement("canvas").getContext("2d").createPattern(pattern.image,"repeat");pattern.width=pattern.image.width;pattern.height=pattern.image.height;delete pattern.image}}setTimeout(creator,0)}function createImagePattern(image){if(isString(image)){image=loadImage(image)}return new _ch_ImagePattern(image)}function drawImageTriangle(x0,y0,x1,y1,x2,y2,u0,v0,u1,v1,u2,v2,image){var a,b,c,d,e,f,w,h,det,idet;var isCHPattern=image instanceof _ch_ImagePattern;if(isCHPattern&&!image.pattern){image=image.image;isCHPattern=false}var isImage=image instanceof Image||image instanceof HTMLCanvasElement;_ch_ctx.beginPath();_ch_ctx.moveTo(x0,y0);_ch_ctx.lineTo(x1,y1);_ch_ctx.lineTo(x2,y2);_ch_ctx.closePath();if(isImage){w=image.width-.5;h=image.height-.5;u0*=w;v0*=h;u1*=w;v1*=h;u2*=w;v2*=h}else if(isCHPattern){w=image.width;h=image.height;u0*=w;v0*=h;u1*=w;v1*=h;u2*=w;v2*=h;image=image.pattern}x1-=x0;y1-=y0;x2-=x0;y2-=y0;u1-=u0;v1-=v0;u2-=u0;v2-=v0;det=u1*v2-u2*v1;idet=1/det;a=(v2*x1-v1*x2)*idet;b=(v2*y1-v1*y2)*idet;c=(u1*x2-u2*x1)*idet;d=(u1*y2-u2*y1)*idet;e=x0-a*u0-c*v0;f=y0-b*u0-d*v0;_ch_ctx.save();if(isImage){_ch_ctx.clip();_ch_ctx.transform(a,b,c,d,e,f);_ch_ctx.drawImage(image,0,0)}else{_ch_ctx.transform(a,b,c,d,e,f);_ch_ctx.fillStyle=image;_ch_ctx.fill()}_ch_ctx.restore()}function strokeLine(x0,y0,x1,y1,color,thickness){_ch_checkArgs(arguments,6,"strokeLine(x0, y0, x1, y1, color, thickness)");_ch_ctx.lineWidth=thickness;_ch_ctx.strokeStyle=color;_ch_ctx.beginPath();_ch_ctx.moveTo(x0,y0);_ch_ctx.lineTo(x1,y1);_ch_ctx.stroke()}function makeColor(r,g,b,opacity){_ch_checkArgs(arguments,3,"makeColor(r, g, b, <a>)");if(typeof r!=="number"){_ch_error("The arguments to makeColor() must all be numbers.")}opacity=opacity===undefined?1:opacity;return"rgba("+Math.round(r*255)+", "+Math.round(g*255)+", "+Math.round(b*255)+", "+opacity+")"}function loadImage(url,onLoad){_ch_checkArgs(arguments,1,"loadImage(url, <onLoad>)");var im=new Image;im.loaded=false;im.onload=function(){if(!im.loaded){im.loaded=true;if(typeof onLoad==="function"){_ch_safeApply(onLoad,im)}}};im.src=url;return im}function loadSound(url){_ch_checkArgs(arguments,1,"loadSound(url)");if(!isString(url)){_ch_error("loadSound() requires a url string argument")}if(url.substring(url.length-4).toLowerCase()!==".mp3"){_ch_error('loadSound() requires that url end in ".mp3"')}if(_ch_audioContext){var sound=Object.seal({src:url,loaded:false,source:null,buffer:null,playing:false});var request=new XMLHttpRequest;request.open("GET",url,true);request.responseType="arraybuffer";request.onload=function(){_ch_audioContext.decodeAudioData(request.response,function onSuccess(buffer){sound.buffer=buffer;sound.loaded=true;sound.source=_ch_audioContext.createBufferSource();sound.source.buffer=sound.buffer;sound.source.connect(_ch_audioContext.destination)},function onFailure(){console.warn("Could not load sound "+url)})};sound.playing=false;request.send();return sound}else{var s=new Audio;s.src=url;s.preload="auto";s.playing=false;s.onended=function(){s.playing=false};s.onpause=s.onended;if(false){_ch_soundLoadQueue.push(s)}else{s.load()}return s}}function playSound(sound,loop){_ch_checkArgs(arguments,1,"playSound(sound, <loop>)");if(!isObject(sound)){_ch_error("The first argument to playSound must be a sound loaded with loadSound.")}loop=loop?true:false;if(_ch_audioContext){if(sound.loaded){sound.source=_ch_audioContext.createBufferSource();sound.source.buffer=sound.buffer;sound.source.connect(_ch_audioContext.destination);sound.source.loop=loop;sound.source.onended=function(){sound.source=null;sound.playing=false};if(!sound.source.start){sound.source.start=sound.source.noteOn;sound.source.stop=sound.source.noteOff}sound.playing=true;sound.source.start(0)}}else{if(_ch_audioContext&&!sound.webAudioSound){sound.webAudioSound=_ch_audioContext.createMediaElementSource(sound);sound.webAudioSound.connect(_ch_audioContext.destination)}try{if(!loop){sound.currentTime=0}if(sound.loop!=loop){sound.loop=loop}if(!loop||sound.paused||sound.ended){sound.play();sound.playing=true}}catch(e){}}}function playingSound(s){_ch_checkArgs(arguments,1,"playingSound(sound)");if(!_ch_audioContext){return!s.paused&&!s.ended&&s.playing}else{return s.playing}}function stopSound(s){_ch_checkArgs(arguments,1,"stopSound(sound)");if(!_ch_audioContext){try{if(!(s.paused||s.ended)){s.pause();s.playing=false}}catch(e){}}else if(s.playing){s.source.stop(0);s.playing=false;s.source=null}}function defineGlobals(module){_ch_checkArgs(arguments,1,"defineGlobals(module)");var global=function(){return this}.call();for(name in module){global[name]=module[name]}}function vec2(x,y){if(y===undefined){_ch_checkExactArgs(arguments,1,"vec2(v)");return Object.seal({x:x.x,y:x.y})}else{_ch_checkExactArgs(arguments,2,"vec2(x, y)");return Object.seal({x:x,y:y})}}function vec3(x,y,z){if(z===undefined){_ch_checkExactArgs(arguments,1,"vec3(v)");return Object.seal({x:x.x,y:x.y,z:x.z})}else{_ch_checkExactArgs(arguments,3,"vec3(x, y, z)");return Object.seal({x:x,y:y,z:z})}}function isNumber(x){return typeof x==="number"}function isBoolean(x){return typeof x==="boolean"}var isArray=Array.isArray;function isString(x){return typeof x==="string"}function isObject(x){return typeof x==="object"&&!isArray(x)}function isFunction(x){return typeof x==="function"}function add(a,b){_ch_checkExactArgs(arguments,2,"add(a, b)");return _ch_vecApply("add",_ch_add,a,b)}function _ch_add(x,y){return x+y}function sub(a,b){_ch_checkArgs(arguments,2,"sub(a, b)");return _ch_vecApply("sub",_ch_sub,a,b)}function _ch_sub(x,y){return x-y}function div(a,b){_ch_checkArgs(arguments,2,"div(a, b)");return _ch_vecApply("div",_ch_div,a,b)}function _ch_div(x,y){return x/y}function mul(a,b){_ch_checkExactArgs(arguments,2,"mul(a, b)");return _ch_vecApply("mul",_ch_mul,a,b)}function _ch_mul(x,y){return x*y}function direction(v){_ch_checkExactArgs(arguments,1,"direction(v)");var m=magnitude(v);if(m===0){return mul(v,0)}else{return div(v,m)}}function _ch_square(x){return x*x}function dot(a,b){_ch_checkExactArgs(arguments,2,"dot(a, b)");var c=0,i,p;if(isNumber(a)){c=a*b}else if(isArray(a)){for(i=0;i<a.length;++i)c+=a[i]*b[i]}else{for(p in a)if(a.hasOwnProperty(p))c+=a[p]*b[p]}return c}function cross(a,b){_ch_checkExactArgs(arguments,2,"cross(a, b)");if("z"in a){return vec3(a.y*b.z-a.z*b.y,a.z*b.x-a.x*b.z,a.x*b.y-a.y*b.x)}else{return a.x*b.y-a.y*b.x}}function magnitude(v){_ch_checkExactArgs(arguments,1,"magnitude(v)");var c=0,i=0,p;if(isNumber(v)){c=Math.abs(v)}else if(isArray(v)){for(i=0;i<v.length;++i)c+=_ch_square(v[i]);c=sqrt(c)}else{for(p in v)if(v.hasOwnProperty(p))c+=_ch_square(v[p]);c=sqrt(c)}return c}function _ch_vecApply(opname,op,a,b){var c,i,p;var noB=b===undefined;if(isNumber(a)){if(noB||isNumber(b)){c=op(a,b)}else if(isArray(b)){c=[];for(i=0;i<b.length;++i)c[i]=op(a,b[i])}else{c=Object.create(Object.getPrototypeOf(b));for(p in b)if(b.hasOwnProperty(p))c[p]=op(a,b[p])}}else if(!noB&&isNumber(b)){if(isArray(a)){c=[];for(i=0;i<a.length;++i)c[i]=op(a[i],b)}else{c=Object.create(Object.getPrototypeOf(a));for(p in a)if(a.hasOwnProperty(p))c[p]=op(a[p],b)}}else if(isArray(a)){if(noB){c=[];for(i=0;i<a.length;++i)c[i]=op(a[i])}else{if(!noB&&!isArray(b))_ch_error("Cannot apply "+opname+" an array and an object");if(!noB&&a.length!==b.length)_ch_error("Cannot apply "+opname+" to arrays of different lengths");c=[];for(i=0;i<a.length;++i)c[i]=op(a[i],b[i])}}else if(noB){c=Object.create(Object.getPrototypeOf(a));for(p in a)if(a.hasOwnProperty(p))c[p]=op(a[p])}else{if(isArray(b))_ch_error("Cannot apply "+opname+" an object and an array");p=Object.getPrototypeOf(a);if(p!==Object.getPrototypeOf(b))_ch_error("Cannot apply "+opname+" to "+a+" and "+b+" because they have different prototypes");c=Object.create(p);for(p in a)if(a.hasOwnProperty(p))c[p]=op(a[p],b[p])}return c}function makeArray(xlength,ylength,zlength){xlength=xlength||0;var a=new Array(xlength);if(ylength!==undefined){var x;for(x=0;x<xlength;++x){a[x]=makeArray(ylength,zlength)}}return a}function makeObject(){return new Object}function resizeArray(a,n){_ch_checkArgs(arguments,2,"resizeArray(a, n)");if(n>a.length){a[n-1]=undefined}else if(n<a.length){a.splice(n,a.length-n)}}function make2DGrid(width,height){var grid=new Array(width);for(var i=0;i<width;++i){grid[i]=new Array(height)}Object.defineProperties(grid,{width:{value:width},height:{value:height}});grid.inBounds=function(x,y){if(x instanceof Object){y=x.y;x=x.x}return x>=0&&x<this.width&&y>=0&&y<this.height};grid.set=function(x,y,v){if(x instanceof Object){v=y;y=x.y;x=x.x}if(this.inBounds(x,y)){this[x][y]=v;return true}else{return false}};grid.get=function(x,y,outOfBoundsValue){if(x instanceof Object){outOfBoundsValue=y;y=x.y;x=x.x}return this.inBounds(x,y)?this[x][y]:outOfBoundsValue};grid.setAll=function(value){for(var x=0;x<this.width;++x){var column=this[x];for(var y=0;y<this.height;++y){column[y]=value}}};grid.forEach=function(callback){for(var x=0;x<this.width;++x){var column=this[x];for(var y=0;y<this.height;++y){if(callback(column[y],x,y,this)===forEach.BREAK){return}}}};grid.__forEach=grid.forEach;grid.rectForEach=function(x0,y0,w,h,callback){var x1=Math.min(x0+w,this.width);var y1=Math.min(y0+h,this.height);x0=Math.max(x0,0);y0=Math.max(y0,0);for(var x=x0;x<x1;++x){var column=this[x];for(var y=y0;y<y1;++y){if(callback(column[y],x,y,this)===forEach.BREAK){return}}}};grid.setRect=function(x0,y0,w,h,value){var x1=Math.min(x0+w,width);var y1=Math.min(y0+h,height);x0=Math.max(x0,0);y0=Math.max(y0,0);for(var x=x0;x<x1;++x){var column=this[x];for(var y=y0;y1<y1;++y){column[y]=value}}};return Object.freeze(grid)}function use(api){switch(api.toLowerCase()){case"box2d":_ch_includeBox2d();break;case"online":_ch_includeOnline();break;default:_ch_error("Unknown use() API: "+api);break}}(function(ctx){var sprintf=function(){if(!sprintf.cache.hasOwnProperty(arguments[0])){sprintf.cache[arguments[0]]=sprintf.parse(arguments[0])}return sprintf.format.call(null,sprintf.cache[arguments[0]],arguments)};sprintf.format=function(parse_tree,argv){var cursor=1,tree_length=parse_tree.length,node_type="",arg,output=[],i,k,match,pad,pad_character,pad_length;for(i=0;i<tree_length;i++){node_type=get_type(parse_tree[i]);if(node_type==="string"){output.push(parse_tree[i])}else if(node_type==="array"){match=parse_tree[i];if(match[2]){arg=argv[cursor];for(k=0;k<match[2].length;k++){if(!arg.hasOwnProperty(match[2][k])){throw sprintf('[sprintf] property "%s" does not exist',match[2][k])}arg=arg[match[2][k]]}}else if(match[1]){arg=argv[match[1]]}else{arg=argv[cursor++]}if(/[^s]/.test(match[8])&&get_type(arg)!="number"){throw sprintf("[sprintf] expecting number but found %s",get_type(arg))}switch(match[8]){case"b":arg=arg.toString(2);break;case"c":arg=String.fromCharCode(arg);break;case"d":arg=parseInt(arg,10);break;case"e":arg=match[7]?arg.toExponential(match[7]):arg.toExponential();break;case"f":arg=match[7]?parseFloat(arg).toFixed(match[7]):parseFloat(arg);break;case"o":arg=arg.toString(8);break;case"s":arg=(arg=String(arg))&&match[7]?arg.substring(0,match[7]):arg;break;case"u":arg=arg>>>0;break;case"x":arg=arg.toString(16);break;case"X":arg=arg.toString(16).toUpperCase();break}arg=/[def]/.test(match[8])&&match[3]&&arg>=0?"+"+arg:arg;pad_character=match[4]?match[4]==="0"?"0":match[4].charAt(1):" ";pad_length=match[6]-String(arg).length;pad=match[6]?str_repeat(pad_character,pad_length):"";output.push(match[5]?arg+pad:pad+arg)}}return output.join("")};sprintf.cache={};sprintf.parse=function(fmt){var _fmt=fmt,match=[],parse_tree=[],arg_names=0;while(_fmt){if((match=/^[^\x25]+/.exec(_fmt))!==null){parse_tree.push(match[0])}else if((match=/^\x25{2}/.exec(_fmt))!==null){parse_tree.push("%")}else if((match=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(_fmt))!==null){if(match[2]){arg_names|=1;var field_list=[],replacement_field=match[2],field_match=[];if((field_match=/^([a-z_][a-z_\d]*)/i.exec(replacement_field))!==null){field_list.push(field_match[1]);while((replacement_field=replacement_field.substring(field_match[0].length))!==""){if((field_match=/^\.([a-z_][a-z_\d]*)/i.exec(replacement_field))!==null){field_list.push(field_match[1])}else if((field_match=/^\[(\d+)\]/.exec(replacement_field))!==null){field_list.push(field_match[1])}else{throw"[sprintf] huh?"}}}else{throw"[sprintf] huh?"}match[2]=field_list}else{arg_names|=2}if(arg_names===3){throw"[sprintf] mixing positional and named placeholders is not (yet) supported"}parse_tree.push(match)}else{throw"[sprintf] huh?"}_fmt=_fmt.substring(match[0].length)}return parse_tree};var vsprintf=function(fmt,argv,_argv){_argv=argv.slice(0);_argv.splice(0,0,fmt);return sprintf.apply(null,_argv)};function get_type(variable){return Object.prototype.toString.call(variable).slice(8,-1).toLowerCase()}function str_repeat(input,multiplier){for(var output=[];multiplier>0;output[--multiplier]=input){}return output.join("")}ctx.sprintf=sprintf;ctx.vsprintf=vsprintf})(typeof exports!="undefined"?exports:window);function download(url,filename){_ch_checkArgs(arguments,2,"download(url, filename)");var downloader=document.createElement("a");downloader.href=url;downloader.download=filename;if(downloader.click){downloader.click()}else if(document.createEvent){var evt=document.createEvent("MouseEvents");evt.initMouseEvent("click",true,true,window,0,0,0,0,0,false,false,false,false,0,null);downloader.dispatchEvent(evt)}else{window.open(imageAsURL.replace(/^data:image\/[^;]/,"data:application/octet-stream"))}}function _ch_includeBox2d(){var sourcePath=_ch_sourceURL.substring(0,_ch_sourceURL.lastIndexOf("/")+1);var version=Math.floor(_ch_PLAY_VERSION*10)/10;include(sourcePath+"box2d-codeheart.js");var check='<script>if (! box2d) { _ch_error("Could not find box2d-codeheart.js in location \\"'+sourcePath+'\\" from which codeheart.js was loaded."); }</script>';document.write(check)}function _ch_includeOnline(){document.write('<script src="https://cdn.socket.io/socket.io-1.2.1.js"></script>'+"<script>codeheart.io = io;</script>")}var _ch_socket=null;var _ch_SOCKET_OPTIONS={"log level":3,"browser client":false,"try multiple transports":true,"connect timeout":1e3,reconnect:false,"reconnection delay":250,"max reconnection attempts":6,transports:["websocket","htmlfile","xhr-polling","jsonp-polling","flashsocket"]};var _ch_serverLog=null;var _ch_clientLog=null;function _ch_log(logElement,htmlMsg,br){if(logElement){br=br||true;logElement.innerHTML+=htmlMsg+(br?"<br/>":false)}}function _ch_resetSocketIO(){for(var url in codeheart.io.sockets){delete codeheart.io.sockets[url]}codeheart.io.j=[]}function generateUniqueID(){_ch_checkArgs(0,"generateUniqueID()");var d=(new Date).getTime();var uuid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(d+Math.random()*16)%16|0;d=Math.floor(d/16);return(c=="x"?r:r&7|8).toString(16)});return uuid}var _ch_ServerState=Object.freeze({OFFLINE:"OFFLINE",ONLINE:"ONLINE",CONNECTING:"CONNECTING",BEING_KICKED:"BEING_KICKED",SERVER_DISCONNECTING:"SERVER_DISCONNECTING",CLIENT_DISCONNECTING:"CLIENT_DISCONNECTING",DISRUPTED:"DISRUPTED"});var _ch_server={state:_ch_ServerState.OFFLINE,gameName:"",serverName:"",relayURL:"",clientTable:{}};function openOnlineGame(relayURL,gameName,serverName){_ch_checkArgs(3,"openOnlineGame(relayURL, gameName, serverName)");if(_ch_server.state!==_ch_ServerState.OFFLINE){_ch_error("Cannot open online game while already connected.")}_ch_server.relayURL=relayURL;_ch_server.gameName=gameName;_ch_server.serverName=serverName;if(_ch_socket!==null){_ch_error("Cannot open online game while connection exists to any game.")}_ch_resetSocketIO();_ch_clientTable={};_ch_socket=null;_ch_log(_ch_serverLog,"Connecting to relay at "+relayURL);_ch_server.state=_ch_ServerState.CONNECTING;if(relayURL===""){setTimeout(function(){_ch_log(_ch_serverLog,"Connected to relay.");_ch_serverProcess_onOpenOnlineGame({relayNotes:"virtual relay"})},0);return}_ch_socket=codeheart.io.connect(relayURL,_ch_SOCKET_OPTIONS);_ch_socket.on("connect",function(){_ch_log(_ch_serverLog,"Connected to relay.");_ch_socket.emit("openOnlineGame",{gameName:gameName,serverName:serverName});if(_ch_server.state!==_ch_ServerState.CONNECTING){_ch_log(_ch_serverLog,"Warning: received Socket.IO connect event while in state "+_ch_server.state)}});_ch_socket.on("onOpenOnlineGameFail",function(msg){_ch_log(_ch_serverLog,"Connect failed because "+msg.reason);if(typeof onOpenOnlineGameFail==="function"){_ch_safeApply(onOpenOnlineGameFail,msg.reason)}if(_ch_server.state!==_ch_ServerState.CONNECTING){_ch_log(_ch_serverLog,"Warning: received Socket.IO onOpenOnlineGameFail event while in state "+_ch_server.state)}});_ch_socket.socket.on("error",function(){if(_ch_server.state===_ch_ServerState.CONNECTING){_ch_log(_ch_serverLog,"Connect failed because unreachable");if(typeof onOpenOnlineGameFail==="function"){_ch_safeApply(onOpenOnlineGameFail,"unreachable")}}});_ch_socket.on("onOpenOnlineGame",_ch_serverProcess_onOpenOnlineGame);_ch_socket.on("joinOnlineGame",_ch_serverProcess_joinOnlineGame);_ch_socket.on("message",_ch_serverProcess_message);_ch_socket.on("leaveOnlineGame",_ch_serverProcess_leaveOnlineGame);_ch_socket.on("disconnect",_ch_serverProcess_disconnect)}function _ch_serverProcess_disconnect(){_ch_log(_ch_serverLog,"Disconnected from relay.");if(_ch_server.state===_ch_ServerState.CONNECTING){}else if(_ch_server.state===_ch_ServerState.SERVER_DISCONNECTING){if(typeof onCloseOnlineGame==="function"){_ch_safeApply(onCloseOnlineGame,"closeOnlineGame");
}}else if(_ch_server.state===_ch_ServerState.ONLINE){if(_ch_client.isLocal){_ch_clientProcess_disconnect()}if(typeof onCloseOnlineGame==="function"){_ch_safeApply(onCloseOnlineGame,"disrupted")}}else{_ch_log(_ch_serverLog,"Warning: received Socket.IO disconnect event while in state "+_ch_server.state)}_ch_server.state=_ch_ServerState.OFFLINE}function _ch_serverProcess_joinOnlineGame(msg){_ch_log(_ch_serverLog,msg.clientID+" connected remotely.");_ch_server.clientTable[msg.clientID]={isLocal:false};if(typeof onClientJoin==="function"){_ch_safeApply(onClientJoin,msg.clientID)}}function _ch_serverProcess_onOpenOnlineGame(msg){_ch_log(_ch_serverLog,"Registered with relay.");_ch_log(_ch_serverLog,'Relay notes for developer: "'+msg.relayNotes+'"');console.log(msg.relayNotes);if(typeof onOpenOnlineGame==="function"){_ch_safeApply(onOpenOnlineGame)}if(_ch_server.state!==_ch_ServerState.CONNECTING){_ch_log(_ch_serverLog,"Warning: received Socket.IO onOpenOnlineGame event while in state "+_ch_server.state)}_ch_server.state=_ch_ServerState.ONLINE}function _ch_serverProcess_leaveOnlineGame(msg){_ch_log(_ch_serverLog,msg.clientID+" disconnected.");delete _ch_server.clientTable[msg.clientID];if(typeof onClientDisconnect==="function"){_ch_safeApply(onClientLeave,msg.clientID)}}function _ch_serverProcess_message(msg){_ch_log(_ch_serverLog,msg.clientID+": "+msg.data);if(typeof onReceiveFromClient==="function"){_ch_safeApply(onReceiveFromClient,msg.clientID,msg.type,msg.data)}}function sendToClient(clientID,messageType,messageBody){_ch_checkArgs(3,"sendToClient(clientID, messageType, messageBody)");if(_ch_isLocalClientID(clientID)){setTimeout(function(){_ch_clientProcess_message({type:messageType,data:JSON.parse(JSON.stringify(messageBody))})},0)}if(_ch_socket){_ch_socket.emit("message",{clientID:clientID,type:messageType,data:messageBody})}}function kickClient(clientID,explanation){_ch_checkArgs(2,"kickClient(clientID, explanation)");if(_ch_isLocalClientID(clientID)){setTimeout(function(){_ch_clientProcess_kickClient({explanation:explanation});_ch_clientProcess_disconnect()})}if(_ch_socket){_ch_socket.emit("kickClient",{clientID:clientID,explanation:explanation})}}function closeOnlineGame(){_ch_checkArgs(0,"closeOnlineGame()");if(_ch_client.isLocal){_ch_log(_ch_serverLog,"Disconnecting local client...");setTimeout(function(){_ch_clientProcess_closeOnlineGame();_ch_clientProcess_disconnect();_ch_log(_ch_serverLog,"Disconnected local client.")})}if(_ch_socket){_ch_log(_ch_serverLog,"Disconnecting from relay...");_ch_socket.emit("closeOnlineGame");_ch_socket.disconnect()}else{_ch_log(_ch_serverLog,"Closing virtual relay connection...");setTimeout(function(){_ch_serverProcess_disconnect();_ch_log(_ch_serverLog,"Closed virtual relay connection.")})}}var _ch_client={state:_ch_ServerState.OFFLINE,clientID:"",isLocal:false,disconnectExplanation:""};function _ch_isLocalClientID(clientID){return _ch_client.isLocal&&(clientID===_ch_client.clientID||clientID==="*"||clientID.substring(0,4)==="* - "&&clientID.substring(4)!==_ch_client.clientID)}function requestServerList(relayURL,gameName){_ch_checkArgs(arguments,2,"requestServerList(relayURL, gameName)");_ch_log(_ch_clientLog,"Connecting to relay "+relayURL+" to request server list");if(relayURL===""){setTimeout(function(){if(_ch_server.state===_ch_ServerState.ONLINE&&relayURL===_ch_server.relayURL&&gameName===_ch_server.gameName){if(typeof onReceiveServerList==="function"){_ch_safeApply(onReceiveServerList,[{serverName:_ch_server.serverName}])}}else{if(typeof onReceiveServerList==="function"){_ch_safeApply(onReceiveServerList,[])}}},0);return}_ch_resetSocketIO();var slSocket=codeheart.io.connect(relayURL,_ch_SOCKET_OPTIONS);var gotList=false;slSocket.on("connect",function(){_ch_log(_ch_clientLog,"Connected to relay to request server list.");slSocket.emit("requestServerList",{gameName:gameName});slSocket.on("onReceiveServerList",function(msg){gotList=true;_ch_log(_ch_clientLog,"Received list of "+msg.serverList.length+" servers.");if(typeof onReceiveServerList==="function"){_ch_safeApply(onReceiveServerList,msg.serverList)}slSocket.disconnect()})});function failure(){if(!gotList){_ch_log(_ch_clientLog,"Failed to connect to relay while requesting server list.");if(typeof onReceiveServerList==="function"){_ch_safeApply(onReceiveServerList,[])}}else{_ch_log(_ch_clientLog,"Disconnected from relay after receiving server list.")}}slSocket.on("disconnect",failure);slSocket.on("error",failure);slSocket.on("connect_failed",failure)}function joinOnlineGame(relayURL,gameName,serverName,clientID){_ch_checkArgs(arguments,3,"joinOnlineGame(relayURL, gameName, ServerName)");_ch_checkID(clientID);if(_ch_client.state!==_ch_ServerState.OFFLINE){_ch_error("Cannot join online game while already connected.")}_ch_clientTable={};_ch_resetSocketIO();_ch_client.clientID=clientID;_ch_client.isLocal=_ch_server.state!==_ch_ServerState.OFFLINE&&_ch_server.relayURL===relayURL&&_ch_server.gameName===gameName&&_ch_server.serverName===serverName;_ch_client.state=_ch_ServerState.CONNECTING;if(_ch_client.isLocal){if(_ch_server.clientTable[clientID]){setTimeout(function(){_ch_log(_ch_clientLog,"Failed to connect as a local client because another client already exists with this ID");_ch_clientProcess_onJoinOnlineGameFail({reason:"duplicate"})},0)}else{setTimeout(function(){_ch_log(_ch_clientLog,"Connected as local client");_ch_log(_ch_serverLog,"A local client connected");_ch_server.clientTable[clientID]={isLocal:true};if(typeof onClientJoin==="function"){_ch_safeApply(onClientJoin,clientID)}_ch_clientProcess_onJoinOnlineGame()},0)}return}if(_ch_socket!==null){_ch_error("Cannot connect to a different game as a client while hosting one as a server.")}_ch_log(_ch_clientLog,"Connecting to relay at "+relayURL+"...");_ch_socket=codeheart.io.connect(relayURL,_ch_SOCKET_OPTIONS);_ch_socket.on("connect",function(){_ch_log(_ch_clientLog,"Connected to relay.");_ch_socket.emit("joinOnlineGame",{gameName:gameName,serverName:serverName,clientID:clientID})});_ch_socket.on("error",function(){if(_ch_client.state===_ch_ServerState.CONNECTING){_ch_log(_ch_clientLog,"Connect failed because unreachable");_ch_client.state=_ch_ServerState.OFFLINE;if(typeof onJoinOnlineGameFail==="function"){_ch_safeApply(onJoinOnlineGameFail,"unreachable")}}});_ch_socket.on("onJoinOnlineGame",_ch_clientProcess_onJoinOnlineGame);_ch_socket.on("onJoinOnlineGameFail",_ch_clientProcess_onJoinOnlineGameFail);_ch_socket.on("kickClient",_ch_clientProcess_kickClient);_ch_socket.on("closeOnlineGame",_ch_clientProcess_closeOnlineGame);_ch_socket.on("disconnect",_ch_clientProcess_disconnect);_ch_socket.on("message",_ch_clientProcess_message)}function _ch_clientProcess_onJoinOnlineGameFail(msg){_ch_log(_ch_clientLog,"Connect failed because "+msg.reason);_ch_client.state=_ch_ServerState.OFFLINE;if(typeof onJoinOnlineGameFail==="function"){_ch_safeApply(onJoinOnlineGameFail,msg.reason)}}function _ch_clientProcess_onJoinOnlineGame(){_ch_client.state=_ch_ServerState.ONLINE;if(typeof onJoinOnlineGame==="function"){_ch_safeApply(onJoinOnlineGame)}}function _ch_clientProcess_closeOnlineGame(){_ch_log(_ch_clientLog,"Received closeOnlineGame message.");_ch_client.state=_ch_ServerState.SERVER_DISCONNECTING}function _ch_clientProcess_message(msg){_ch_log(_ch_clientLog,"Server: "+msg.data);if(typeof onReceiveFromServer==="function"){_ch_safeApply(onReceiveFromServer,msg.type,msg.data)}}function _ch_clientProcess_kickClient(msg){_ch_checkArgs(0,"_ch_clientProcess_kickClient()");_ch_log(_ch_clientLog,"Received kickClient message.");_ch_client.state=_ch_ServerState.BEING_KICKED;_ch_client.disconnectExplanation=msg.explanation}function _ch_clientProcess_disconnect(){_ch_checkArgs(0,"_ch_clientProcess_disconnect()");_ch_log(_ch_clientLog,"Disconnected from server.");if(_ch_client.state===_ch_ServerState.CONNECTING){}else{var reason="";if(_ch_client.state===_ch_ServerState.BEING_KICKED){reason="kickClient"}else if(_ch_client.state===_ch_ServerState.SERVER_DISCONNECTING){reason="closeOnlineGame"}else if(_ch_client.state===_ch_ServerState.CLIENT_DISCONNECTING){reason="leaveOnlineGame"}else if(_ch_client.state===_ch_ServerState.ONLINE){reason="disrupted"}if(typeof onLeaveOnlineGame==="function"){_ch_safeApply(onLeaveOnlineGame,reason,_ch_client.disconnectExplanation)}}_ch_client.state=_ch_ServerState.OFFLINE;_ch_client.isLocal=false;_ch_client.disconnectExplanation=""}function sendToServer(messageType,messageBody){_ch_checkArgs(2,"sendToServer(messageType, messageBody)");if(_ch_client.isLocal){setTimeout(function(){_ch_serverProcess_message({clientID:_ch_client.clientID,type:messageType,data:JSON.parse(JSON.stringify(messageBody))})},0)}else if(_ch_socket){_ch_socket.emit("message",{type:messageType,data:messageBody})}}function leaveOnlineGame(){_ch_checkArgs(0,"leaveOnlineGame()");_ch_client.state=_ch_ServerState.CLIENT_DISCONNECTING;if(_ch_client.isLocal){_ch_log(_ch_clientLog,"Disconnecting from local server...");setTimeout(function(){_ch_serverProcess_leaveOnlineGame({clientID:_ch_client.clientID});_ch_clientProcess_disconnect()},0)}else{_ch_log(_ch_clientLog,"Disconnecting from remote server...");_ch_socket.disconnect()}}function distance2Squared(v1,v2){return square(v1.x-v2.x)+square(v1.y-v2.y)}function distance2(v1,v2){return Math.sqrt(distance2Squared(v1,v2))}function makeSprite(image,x,y,width,height,flipX,flipY,rotation,imageSmoothing){_ch_checkArgs(arguments,5,"makeSprite(image, x, y, width, height, <flipX>, <flipY>, <rotation>, <imageSmoothing>)");return new Sprite(image,x,y,width,height,flipX,flipY,rotation,imageSmoothing===undefined?!_ch_pixelate:imageSmoothing)}function Sprite(image,x,y,width,height,flipX,flipY,rotation,imageSmoothing){if(!(this instanceof Sprite)){_ch_error("Must call 'new Sprite(...)' or 'makeSprite(...)'")}this.image=image;this.x=x;this.y=y;this.width=width;this.height=height;this.flipX=flipX?true:false;this.flipY=flipY?true:false;this.rotation=rotation||0;this.imageSmoothing=imageSmoothing===undefined?true:imageSmoothing;Object.freeze(this)}function Entity(position,sprite,size,rotation,isDisk,visibleSize,opacity){_ch_checkArgs(arguments,3,"new Entity(position, sprite, size, <rotation>, <isDisk>, <visibleSize>, <opacity>");if(!(this instanceof Entity)){_ch_error("Must call 'new Entity()'")}this.position=vec2(position);this.sprite=sprite;this.rotation=rotation||0;this.size=vec2(size);this.isDisk=isDisk!==undefined?isDisk:false;this.visibleSize=visibleSize?vec2(visibleSize):null;this.opacity=opacity!==undefined?opacity:1;console.assert(!this.isDisk||this.size.x===this.size.y)}Entity.prototype.draw=function(opacity){if(this.sprite){var visibleSize=this.visibleSize||this.size;if(opacity===undefined){opacity=1}opacity*=this.opacity;if(this.sprite instanceof Sprite){_ch_drawTransformedImage(this.sprite.image,this.position.x,this.position.y,this.rotation+this.sprite.rotation,(this.sprite.flipX?-1:1)*visibleSize.x/this.sprite.width,(this.sprite.flipY?-1:1)*visibleSize.y/this.sprite.height,this.sprite.x,this.sprite.y,this.sprite.width,this.sprite.height,opacity)}else{_ch_drawTransformedImage(this.sprite,this.position.x,this.position.y,this.rotation,visibleSize.x/this.sprite.width,visibleSize.y/this.sprite.height,0,0,this.sprite.width,this.sprite.height,opacity)}}};Entity.prototype.drawBounds=function(color){color=color||"#F44";_ch_ctx.save();_ch_ctx.translate(this.position.x,this.position.y);_ch_ctx.rotate(this.rotation);if(this.isDisk){strokeCircle(0,0,this.size.x*.5,color,2)}else{strokeRectangle(-this.size.x*.5,-this.size.y*.5,this.size.x,this.size.y,color,2)}strokeLine(0,0,this.size.x*.5,0,color,2);_ch_ctx.restore()};Entity.prototype.toFrame=function(v,out){var x=v.x-this.position.x;var y=v.y-this.position.y;var c=Math.cos(-this.rotation);var s=Math.sin(-this.rotation);if(out===undefined){out={x:0,y:0}}out.x=x*c+y*s;out.y=y*c-x*s;return out};Entity.prototype.fromFrame=function(v,output){var c=Math.cos(this.rotation);var s=Math.sin(this.rotation);if(out===undefined){out={x:0,y:0}}out.x=v.x*c+v.y*s+this.position.x;out.y=v.y*c-v.x*s+this.position.y;return out};Entity.prototype.containsPoint=function(P){if(this.isDisk){return distance2Squared(P,this.position)<=square(this.size.x*.5)}else if(this.rotation===0){return Math.abs(P.x-this.position.x)<=this.size.x*.5&&Math.abs(P.y-this.position.y)<=this.size.y*.5}else{P=this.toFrame(P);return Math.abs(P.x)<=this.size.x*.5&&Math.abs(P.y)<=this.size.y*.5}};function distanceSquared2D(u,v){return square(u.x-v.x)+square(u.y-v.y)}Entity.prototype.overlaps=function(){var temp=vec2(0,0);var temp2=vec2(0,0);function obbOverlapOneWay(A,B,offsetX,offsetY){temp2.x=B.position.x-offsetX;temp2.y=B.position.y-offsetY;var center=A.toFrame(temp2,temp);var angle=B.rotation-A.rotation;var c=Math.cos(angle);var s=Math.sin(angle);var loX=Infinity,loY=Infinity;var hiX=-Infinity,hiY=-Infinity;for(var signX=-1;signX<=+1;signX+=2){for(var signY=-1;signY<=+1;signY+=2){var xx=signX*B.size.x*.5;var yy=signY*B.size.y*.5;var cornerX=xx*c+yy*s;var cornerY=xx*-s+yy*c;loX=Math.min(loX,cornerX);loY=Math.min(loY,cornerY);hiX=Math.max(hiX,cornerX);hiY=Math.max(hiY,cornerY)}}loX+=center.x;loY+=center.y;hiX+=center.x;hiY+=center.y;return loX<=A.size.x*.5&&hiX>=-A.size.x*.5&&loY<=A.size.y*.5&&hiY>=-A.size.y*.5}return function(entity,offsetX,offsetY){offsetX=offsetX||0;if(offsetX.x!==undefined){if(offsetY!==undefined){_ch_error("If offsetX is a vec2 then you may not specify offsetY")}offsetY=offsetX.y;offsetX=offsetX.x}else{offsetY=offsetY||0}var A=this,B=entity;if(A.isDisk){var temp=A;A=B;B=temp;offsetX=-offsetX;offsetY=-offsetY}temp2.x=B.position.x-offsetX;temp2.y=B.position.y-offsetY;if(A.isDisk){return distanceSquared2D(A.position,temp2)*4<square(A.size.x+B.size.x)}else if(B.isDisk){var P=A.toFrame(temp2,temp);P.x=2*Math.abs(P.x);P.y=2*Math.abs(P.y);if(P.x>A.size.x+B.size.x||P.y>A.size.y+B.size.y){return false}else if(P.x<=A.size.x||P.y<=A.size.y){return true}else{return distanceSquared2D(P,A.size)<=square(B.size.x)}}else if(A.rotation===0&&B.rotation===0){return Math.abs(A.position.x-temp2.x)*2<=A.size.x+B.size.x&&Math.abs(A.position.y-temp2.y)*2<=A.size.y+B.size.y}else{return obbOverlapOneWay(A,B,offsetX,offsetY)&&obbOverlapOneWay(B,A,-offsetX,-offsetY)}}}();function Camera(pixelsPerMeter,upY){if(upY!==undefined&&Math.abs(upY)!==1){_ch_error("upY must be -1, +1, or undefined")}this.position=vec2(0,0);this.upY=(upY||-1)|0;pixelsPerMeter=pixelsPerMeter||40;var metersPerPixel=1/pixelsPerMeter;Object.defineProperties(this,{metersPerPixel:{get:function(){return metersPerPixel},set:function(m){metersPerPixel=m;pixelsPerMeter=1/m}},pixelsPerMeter:{get:function(){return pixelsPerMeter},set:function(p){pixelsPerMeter=p;metersPerPixel=1/p}}})}Camera.prototype.toScreen=function(world,screen){screen=screen||vec2(0,0);screen.x=screenWidth*.5+(world.x-this.position.x)/this.metersPerPixel;screen.y=screenHeight*.5-this.upY*(world.y-this.position.y)/this.metersPerPixel;return screen};Camera.prototype.toWorld=function(screen,world){world=world||vec2(0,0);world.x=(screen.x-screenWidth*.5)*this.metersPerPixel+this.position.x;world.y=-this.upY*(screen.y-screenHeight*.5)*this.metersPerPixel+this.position.y;return world};Camera.prototype.pushTransform=function(){_ch_ctx.save();_ch_ctx.translate(screenWidth/2,screenHeight/2);_ch_ctx.scale(this.pixelsPerMeter,-this.upY*this.pixelsPerMeter);_ch_ctx.translate(-camera.position.x,-camera.position.y);_ch_ctx.lineWidth=this.metersPerPixel};Camera.prototype.popTransform=function(){_ch_ctx.restore()};Camera.prototype.fillText=function(text,worldPosition,color,style,xAlign,yAlign,angle){_ch_ctx.save();_ch_ctx.translate(worldPosition.x,worldPosition.y);if(angle){_ch_ctx.rotate(angle)}_ch_ctx.scale(this.metersPerPixel,-this.upY*this.metersPerPixel);_ch_ctx.textAlign=xAlign||"center";_ch_ctx.textBaseline=yAlign||"midddle";_ch_ctx.font=style;_ch_ctx.fillStyle=color;try{_ch_ctx.fillText(text,0,0)}catch(e){}_ch_ctx.restore()};var _ch_tempCanvas=undefined;function imageTransform(image,imageCallback){if(!_ch_tempCanvas){_ch_tempCanvas=document.createElement("canvas")}var w=image.width;var h=image.height;_ch_tempCanvas.width=w;_ch_tempCanvas.height=h;var tempCtx=_ch_tempCanvas.getContext("2d");tempCtx.drawImage(image,0,0);try{var imageData=tempCtx.getImageData(0,0,w,h);imageCallback(imageData.data,w,h);tempCtx.putImageData(imageData,0,0)}catch(e){if(e.code===18){_ch_error('This web application cannot be run locally on the Chrome browser using a file:// URL. Load it with IE, Safari, or Firefox, Run it remotely from a web server, or launch a local webserver with "python3 -m http.server" and then load http://localhost:8000/play.html')}else{_ch_error(e)}}var result=new Image;result.src=_ch_tempCanvas.toDataURL("image/png");return result}function pixelTransform(image,pixelCallback){return imageTransform(image,function(pixel,w,h){var value=Object.seal({r:0,g:0,b:0,a:0});for(var p=vec2(0,0),i=0;p.y<h;++p.y){for(p.x=0;p.x<w;++p.x,i+=4){value.r=pixel[i+0];value.g=pixel[i+1];value.b=pixel[i+2];value.a=pixel[i+3];pixelCallback(value,p);pixel[i+0]=value.r;pixel[i+1]=value.g;pixel[i+2]=value.b;pixel[i+3]=value.a}}})}(function(){var _keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function compressToBase64(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=compress(input);while(i<input.length*2){if(i&1){chr1=input.charCodeAt(i-1>>1)&255;if(i+1>>1<input.length){chr2=input.charCodeAt(i+1>>1)>>8;chr3=input.charCodeAt(i+1>>1)&255}else{chr2=chr3=NaN}}else{chr1=input.charCodeAt(i>>1)>>8;chr2=input.charCodeAt(i>>1)&255;if((i>>1)+1<input.length){chr3=input.charCodeAt((i>>1)+1)>>8}else{chr3=NaN}}i+=3;enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output+=_keyStr.charAt(enc1)+_keyStr.charAt(enc2)+_keyStr.charAt(enc3)+_keyStr.charAt(enc4)}return output}function decompressFromBase64(input){var output="",ol=0,output_,chr1,chr2,chr3,enc1,enc2,enc3,enc4,i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(i<input.length){enc1=_keyStr.indexOf(input.charAt(i++));enc2=_keyStr.indexOf(input.charAt(i++));enc3=_keyStr.indexOf(input.charAt(i++));enc4=_keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;if(ol&1){output=output+String.fromCharCode(output_|chr1);if(enc3!=64){output_=chr2<<8;flush=true}else{flush=false}if(enc4!=64){output+=String.fromCharCode(output_|chr3);flush=false}}else{output_=chr1<<8;if(enc3!=64){output+=String.fromCharCode(output_|chr2);flush=false}else{flush=true}if(enc4!=64){output_=chr3<<8;flush=true}}ol+=3}return decompress(output)}function compress(uncompressed){var i,value,context_dictionary={},context_dictionaryToCreate={},context_c="",context_wc="",context_w="",context_enlargeIn=2,context_dictSize=3,context_numBits=2,context_result="",context_data_string="",context_data_val=0,context_data_position=0,ii;for(ii=0;ii<uncompressed.length;ii+=1){context_c=uncompressed.charAt(ii);if(!context_dictionary.hasOwnProperty(context_c)){context_dictionary[context_c]=context_dictSize++;context_dictionaryToCreate[context_c]=true}context_wc=context_w+context_c;if(context_dictionary.hasOwnProperty(context_wc)){context_w=context_wc}else{if(context_dictionaryToCreate.hasOwnProperty(context_w)){if(context_w.charCodeAt(0)<256){for(i=0;i<context_numBits;i++){context_data_val=context_data_val<<1;if(context_data_position===15){context_data_position=0;context_data_string+=String.fromCharCode(context_data_val);context_data_val=0}else{context_data_position++}}value=context_w.charCodeAt(0);for(i=0;i<8;i++){context_data_val=context_data_val<<1|value&1;if(context_data_position===15){context_data_position=0;context_data_string+=String.fromCharCode(context_data_val);context_data_val=0}else{context_data_position++}value=value>>1}}else{value=1;for(i=0;i<context_numBits;i++){context_data_val=context_data_val<<1|value;if(context_data_position===15){context_data_position=0;context_data_string+=String.fromCharCode(context_data_val);context_data_val=0}else{context_data_position++}value=0}value=context_w.charCodeAt(0);for(i=0;i<16;i++){context_data_val=context_data_val<<1|value&1;if(context_data_position===15){context_data_position=0;context_data_string+=String.fromCharCode(context_data_val);context_data_val=0}else{context_data_position++}value=value>>1}}context_enlargeIn--;if(context_enlargeIn===0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++}delete context_dictionaryToCreate[context_w]}else{value=context_dictionary[context_w];for(i=0;i<context_numBits;i++){context_data_val=context_data_val<<1|value&1;if(context_data_position===15){context_data_position=0;context_data_string+=String.fromCharCode(context_data_val);context_data_val=0}else{context_data_position++}value=value>>1}}context_enlargeIn--;if(context_enlargeIn===0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++}context_dictionary[context_wc]=context_dictSize++;context_w=String(context_c)}}if(context_w!==""){if(context_dictionaryToCreate.hasOwnProperty(context_w)){if(context_w.charCodeAt(0)<256){for(i=0;i<context_numBits;i++){context_data_val=context_data_val<<1;if(context_data_position===15){context_data_position=0;context_data_string+=String.fromCharCode(context_data_val);context_data_val=0}else{context_data_position++}}value=context_w.charCodeAt(0);for(i=0;i<8;i++){context_data_val=context_data_val<<1|value&1;if(context_data_position===15){context_data_position=0;context_data_string+=String.fromCharCode(context_data_val);context_data_val=0}else{context_data_position++}value=value>>1}}else{value=1;for(i=0;i<context_numBits;i++){context_data_val=context_data_val<<1|value;if(context_data_position===15){context_data_position=0;context_data_string+=String.fromCharCode(context_data_val);context_data_val=0}else{context_data_position++}value=0}value=context_w.charCodeAt(0);for(i=0;i<16;i++){context_data_val=context_data_val<<1|value&1;if(context_data_position===15){context_data_position=0;context_data_string+=String.fromCharCode(context_data_val);context_data_val=0}else{context_data_position++}value=value>>1}}context_enlargeIn--;if(context_enlargeIn===0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++}delete context_dictionaryToCreate[context_w]}else{value=context_dictionary[context_w];for(i=0;i<context_numBits;i++){context_data_val=context_data_val<<1|value&1;if(context_data_position===15){context_data_position=0;context_data_string+=String.fromCharCode(context_data_val);context_data_val=0}else{context_data_position++}value=value>>1}}--context_enlargeIn;if(context_enlargeIn===0){context_enlargeIn=1<<context_numBits;++context_numBits}}value=2;for(i=0;i<context_numBits;++i){context_data_val=context_data_val<<1|value&1;if(context_data_position===15){context_data_position=0;context_data_string+=String.fromCharCode(context_data_val);context_data_val=0}else{context_data_position++}value=value>>1}while(true){context_data_val<<=1;if(context_data_position===15){context_data_string+=String.fromCharCode(context_data_val);break}else{++context_data_position}}return context_data_string}function decompress(compressed){var dictionary=[],next,enlargeIn=4,dictSize=4,numBits=3,entry="",result="",i,w,bits,resb,maxpower,power,c,errorCount=0,literal,data={string:compressed,val:compressed.charCodeAt(0),position:32768,index:1};for(i=0;i<3;i+=1){dictionary[i]=i}bits=0;maxpower=4;power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position===0){data.position=32768;data.val=data.string.charCodeAt(data.index++)}bits|=(resb>0?1:0)*power;power<<=1}next=bits;switch(next){case 0:bits=0;maxpower=1<<8;power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position===0){data.position=32768;data.val=data.string.charCodeAt(data.index++)}bits|=(resb>0?1:0)*power;power<<=1}c=String.fromCharCode(bits);break;case 1:bits=0;maxpower=1<<16;power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position===0){data.position=32768;data.val=data.string.charCodeAt(data.index++)}bits|=(resb>0?1:0)*power;power<<=1}c=String.fromCharCode(bits);break;case 2:return""}dictionary[3]=c;w=result=c;while(true){bits=0;maxpower=Math.pow(2,numBits);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position===0){data.position=32768;data.val=data.string.charCodeAt(data.index++)}bits|=(resb>0?1:0)*power;power<<=1}c=bits;switch(c){case 0:if(errorCount++>1e4)return"Error";bits=0;maxpower=1<<8;power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position===0){data.position=32768;data.val=data.string.charCodeAt(data.index++)}bits|=(resb>0?1:0)*power;power<<=1}dictionary[dictSize++]=String.fromCharCode(bits);c=dictSize-1;--enlargeIn;break;case 1:bits=0;maxpower=1<<16;power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position===0){data.position=32768;data.val=data.string.charCodeAt(data.index++)}bits|=(resb>0?1:0)*power;power<<=1}dictionary[dictSize++]=String.fromCharCode(bits);c=dictSize-1;--enlargeIn;break;case 2:return result}if(enlargeIn===0){enlargeIn=1<<numBits;++numBits}if(dictionary[c]){entry=dictionary[c]}else{if(c===dictSize){entry=w+w.charAt(0)}else{return null}}result+=entry;dictionary[dictSize++]=w+entry.charAt(0);--enlargeIn;w=entry;if(enlargeIn===0){enlargeIn=1<<numBits;++numBits}}return result}defineGlobals({compress:compressToBase64,decompress:decompressFromBase64})})();var isMobile=_ch_isMobile;if(!String.repeat){String.prototype.repeat=function(n){if(n>0){return Array(n+1).join(this)}else{return""}}}if(typeof _ch_PLAY_VERSION==="undefined"){_ch_PLAY_VERSION=1}if(_ch_PLAY_VERSION<1.63){console.warn("You are using out of date version "+sprintf("%3.1f",_ch_PLAY_VERSION)+" of play.html.  "+"Please download the latest version of play.html from "+"https://casual-effects.com/codeheart or put the old version of "+"codeheart.js in your directory to prevent this message.")}var codeheart=Object.freeze({VERSION:"2016-08-21 18:45",round:round,canvas:canvas,include:include,error:_ch_error,download:download,drawLogo:drawCodeheartLogo,fillRectangle:fillRectangle,strokeRectangle:strokeRectangle,fillCircle:fillCircle,strokeCircle:strokeCircle,fillSpline:fillSpline,strokeSpline:strokeSpline,drawImage:drawImage,drawTransformedImage:drawTransformedImage,isMobile:_ch_isMobile,isiOS:_ch_isiOS,vec2:vec2,vec3:vec3,playSound:playSound,stopSound:stopSound,loadSound:loadSound,playingSound:playingSound,loadImage:loadImage});